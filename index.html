<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Conquistadores App - Ministerio</title>
    
    <!-- 1. React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 2. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. PropTypes & Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif']
                    },
                    colors: {
                        // Paleta basada en la imagen (Crema + Rojo Borgo√±a)
                        brand: { 50:'#fff1f2', 100:'#ffe4e6', 500:'#e11d48', 600:'#be123c', 700:'#9f1239', 900:'#881337' },
                        cream: '#FAF9F6', // Fondo hueso/crema
                        dark: '#1c1917',   // Casi negro
                        surface: '#ffffff'
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(190, 18, 60, 0.08)',
                        'glow': '0 0 15px rgba(190, 18, 60, 0.3)'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #FAF9F6; color: #1c1917; -webkit-font-smoothing: antialiased; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .animate-enter { animation: enter 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes enter { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .input-ui { @apply w-full bg-stone-50 border border-stone-200 text-stone-800 text-sm rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all font-medium; }
        .label-ui { @apply block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2 ml-1; }
        
        /* Estilo tipo tarjeta elegante */
        .card-elegant { @apply bg-white rounded-2xl shadow-soft border border-stone-100; }
        .btn-brand { @apply bg-brand-700 text-white hover:bg-brand-800 shadow-lg shadow-brand-700/20 active:scale-95 transition-all rounded-xl font-bold; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDXK_EcXsFGhRmXfkKG8SMdsM69c4PNfHw",
            authDomain: "conquistadoresapp.firebaseapp.com",
            projectId: "conquistadoresapp",
            storageBucket: "conquistadoresapp.firebasestorage.app",
            messagingSenderId: "518647225464",
            appId: "1:518647225464:web:b3344ca5172498187e218d"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // --- 2. UTILS & HOOKS ---
        const { useState, useEffect, useMemo } = React;
        const RechartsObj = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, Tooltip: RechartsTooltip, ResponsiveContainer, Cell, PieChart, Pie } = RechartsObj;

        // Icons - CORREGIDO: Se agregaron los fragmentos <>...</> faltantes en Edit, Send y Mail
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Home: <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>,
                Users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
                Music: <><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></>,
                Briefcase: <rect x="2" y="7" width="20" height="14" rx="2" ry="2" transform="translate(0 -2)"/>,
                DollarSign: <><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>,
                Bell: <><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></>,
                Menu: <><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
                ChevronLeft: <polyline points="15 18 9 12 15 6"/>,
                ChevronRight: <polyline points="9 18 15 12 9 6"/>,
                ChevronDown: <polyline points="6 9 12 15 18 9"/>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
                BookOpen: <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
                Smile: <><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
                Mail: <><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || icons.Home}</svg>;
        };

        const formatDate = (d, fmt = 'short') => {
            if(!d) return '';
            const date = new Date(d);
            if(d.length === 10) date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
            if(fmt === 'long') return date.toLocaleDateString('es-AR', { weekday:'long', day: 'numeric', month: 'long' });
            if(fmt === 'month') return date.toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
            return date.toLocaleDateString('es-AR', { day: 'numeric', month: 'short' });
        };

        const formatMoney = (amount) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(amount);

        // Permisos
        const canEdit = (profile, section) => {
            if (!profile) return false;
            if (profile.role === 'Pastor') return true;
            if (profile.role === 'L√≠der' && profile.ministry === section) return true;
            return false;
        };

        // --- 3. UI COMPONENTS ---
        const Button = ({ children, onClick, variant = 'primary', icon, className = "", disabled=false }) => {
            const variants = {
                primary: "btn-brand",
                secondary: "bg-white text-stone-700 border border-stone-200 hover:bg-stone-50",
                danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100",
                ghost: "bg-transparent text-stone-500 hover:bg-stone-100"
            };
            return (
                <button disabled={disabled} onClick={onClick} className={`flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-bold text-sm transition-all disabled:opacity-50 ${variants[variant]} ${className}`}>
                    {icon && <Icon name={icon} size={18} />}{children}
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm animate-enter">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
                        <div className="p-6 border-b border-stone-100 flex justify-between items-center sticky top-0 bg-white/95 backdrop-blur z-10">
                            <h3 className="text-xl font-serif font-bold text-brand-900">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-stone-100 rounded-full transition-colors"><Icon name="X" /></button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        const MultiSelect = ({ options, selected = [], onChange, label }) => {
            const toggle = (val) => {
                if (selected.includes(val)) onChange(selected.filter(x => x !== val));
                else onChange([...selected, val]);
            };
            return (
                <div className="mb-4">
                    <label className="label-ui">{label}</label>
                    <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 border border-stone-200 rounded-xl bg-stone-50">
                        {options.map(opt => (
                            <button key={opt.id} onClick={() => toggle(opt.name)}
                                className={`px-3 py-1 rounded-full text-xs font-bold border transition-all ${selected.includes(opt.name) ? 'bg-brand-700 text-white border-brand-700' : 'bg-white text-stone-600 border-stone-200'}`}>
                                {opt.name}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const AccordionItem = ({ title, subtitle, meta, children, isOpen, onToggle, status }) => (
            <div className={`border border-stone-200 rounded-2xl overflow-hidden transition-all duration-300 ${isOpen ? 'shadow-lg ring-1 ring-brand-500/20 bg-white' : 'bg-white hover:border-brand-200'}`}>
                <div className="p-4 cursor-pointer flex justify-between items-center" onClick={onToggle}>
                    <div className="flex items-center gap-3 overflow-hidden">
                        <div className={`w-1.5 h-10 rounded-full ${status === 'Pendiente' ? 'bg-amber-400' : status === 'Nuevo' ? 'bg-brand-500' : 'bg-emerald-500'}`}></div>
                        <div className="truncate">
                            <h4 className="font-bold text-stone-800 truncate">{title}</h4>
                            <p className="text-xs text-stone-500 font-medium">{subtitle}</p>
                        </div>
                    </div>
                    <div className="text-right flex items-center gap-3 shrink-0">
                        <span className="text-xs font-bold text-stone-400 hidden sm:block">{meta}</span>
                        <Icon name="ChevronDown" className={`text-stone-400 transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} />
                    </div>
                </div>
                {isOpen && <div className="px-6 pb-6 pt-2 border-t border-stone-50 bg-stone-50/50 animate-enter text-sm text-stone-700">{children}</div>}
            </div>
        );

        // --- 4. APP LOGIC ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [quickActionOpen, setQuickActionOpen] = useState(false);

            // Collections
            const [members, setMembers] = useState([]);
            const [finances, setFinances] = useState([]);
            const [worship, setWorship] = useState([]);
            const [servers, setServers] = useState([]);
            const [ebd, setEbd] = useState([]);
            const [youth, setYouth] = useState([]);
            const [messages, setMessages] = useState([]);
            const [songs, setSongs] = useState([]);

            // Listeners
            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        const snap = await db.collection('members').where('email', '==', u.email).get();
                        if (!snap.empty) {
                            setProfile({ ...snap.docs[0].data(), id: snap.docs[0].id });
                        } else {
                            const check = await db.collection('members').get();
                            if(check.empty) {
                                const admin = { name: u.displayName, email: u.email, role: 'Pastor', ministry: 'General', photo: u.photoURL, status: 'Activo' };
                                await db.collection('members').add(admin);
                                setProfile(admin);
                            }
                        }
                    } else { setUser(null); setProfile(null); }
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!profile) return;
                const subs = [
                    db.collection('members').onSnapshot(s => setMembers(s.docs.map(d=>({id:d.id, ...d.data()})))),
                    db.collection('finances').onSnapshot(s => setFinances(s.docs.map(d=>({id:d.id, ...d.data()})))),
                    db.collection('worship').onSnapshot(s => setWorship(s.docs.map(d=>({id:d.id, ...d.data()})))),
                    db.collection('servers').onSnapshot(s => setServers(s.docs.map(d=>({id:d.id, ...d.data()})))),
                    db.collection('ebd').onSnapshot(s => setEbd(s.docs.map(d=>({id:d.id, ...d.data()})))),
                    db.collection('youth').onSnapshot(s => setYouth(s.docs.map(d=>({id:d.id, ...d.data()})))),
                    db.collection('messages').onSnapshot(s => setMessages(s.docs.map(d=>({id:d.id, ...d.data()})))),
                    db.collection('songs').onSnapshot(s => setSongs(s.docs.map(d=>({id:d.id, ...d.data()}))))
                ];
                return () => subs.forEach(unsub => unsub());
            }, [profile]);

            // CRUD Generico
            const add = (col, data) => db.collection(col).add(data);
            const update = (col, id, data) => db.collection(col).doc(id).update(data);
            const del = (col, id) => { if(window.confirm("¬øSeguro de eliminar?")) db.collection(col).doc(id).delete(); };
            
            // Helper: Obtener detalles completos de un d√≠a
            const getFullEventDetails = (dateStr) => {
                const combined = [];
                // Alabanza
                worship.filter(e => e.date === dateStr).forEach(e => combined.push({...e, src:'Alabanza', color:'bg-purple-100 text-purple-800'}));
                // Servidores
                servers.filter(e => e.date === dateStr).forEach(e => combined.push({...e, src:'Servidores', color:'bg-blue-100 text-blue-800'}));
                // EBD
                ebd.filter(e => e.date === dateStr).forEach(e => combined.push({...e, src:'EBD', color:'bg-emerald-100 text-emerald-800'}));
                // Jovenes
                youth.filter(e => e.date === dateStr).forEach(e => combined.push({...e, src:'J√≥venes', color:'bg-orange-100 text-orange-800'}));
                
                return combined;
            };

            // --- VISTAS ---

            const Dashboard = () => {
                // C√°lculo de equidad en servicios
                const serviceCount = useMemo(() => {
                    const counts = {};
                    [...servers, ...worship, ...ebd, ...youth].forEach(ev => {
                         const allAssigned = [
                             ...Object.values(ev.assignments || {}).flat(), 
                             ...Object.values(ev.team || {}).flat()
                         ];
                         allAssigned.forEach(name => { if(name) counts[name] = (counts[name] || 0) + 1; });
                    });
                    return Object.entries(counts).map(([name, val]) => ({name, val})).sort((a,b)=>b.val-a.val).slice(0,8);
                }, [servers, worship, ebd, youth]);

                const nextEvent = [...worship, ...youth, ...servers].filter(e => new Date(e.date) >= new Date().setHours(0,0,0,0)).sort((a,b)=>new Date(a.date)-new Date(b.date))[0];
                const pendingMsgs = messages.filter(m => (m.to === 'all' || m.to === profile.id) && !m.readBy?.includes(profile.id)).length;
                
                // Mis Tareas (Extraer de todos los eventos donde aparezca mi nombre)
                const myTasksCount = [...worship, ...servers, ...ebd, ...youth].filter(ev => {
                    const allAssigned = [...Object.values(ev.assignments || {}).flat(), ...Object.values(ev.team || {}).flat()];
                    return allAssigned.includes(profile.name) && new Date(ev.date) >= new Date();
                }).length;

                return (
                    <div className="space-y-6 animate-enter">
                        <div className="bg-brand-900 rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden">
                            <div className="absolute -right-10 -top-10 text-white/10"><Icon name="Home" size={200} /></div>
                            <h2 className="text-3xl font-serif font-bold mb-2">Bienvenido, {profile.name}</h2>
                            <p className="text-brand-100 max-w-lg mb-6">Panel de control de {profile.ministry}. Tienes <strong>{myTasksCount} actividades</strong> pendientes y <strong>{pendingMsgs} mensajes</strong>.</p>
                            
                            {nextEvent && (
                                <div className="bg-white/10 backdrop-blur rounded-2xl p-4 border border-white/20 inline-flex items-center gap-4">
                                    <div className="text-center border-r border-white/20 pr-4">
                                        <div className="text-xs uppercase font-bold text-brand-200">Pr√≥ximo</div>
                                        <div className="text-2xl font-bold">{new Date(nextEvent.date).getDate()}</div>
                                        <div className="text-xs">{formatDate(nextEvent.date).split(' ')[2]}</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-lg leading-tight">{nextEvent.theme || nextEvent.type}</div>
                                        <div className="text-xs text-brand-200 mt-1 flex gap-2"><Icon name="Calendar" size={12}/> {formatDate(nextEvent.date)} {nextEvent.time}hs</div>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onClick={()=>setActiveTab('messages')} className="card-elegant p-4 hover:border-brand-300 transition-all flex flex-col items-center justify-center gap-2">
                                <div className="bg-amber-100 text-amber-700 p-3 rounded-full relative">
                                    <Icon name="Bell" />
                                    {pendingMsgs > 0 && <span className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>}
                                </div>
                                <span className="font-bold text-stone-700">Buz√≥n</span>
                            </button>
                            <button onClick={()=>setActiveTab('calendar')} className="card-elegant p-4 hover:border-brand-300 transition-all flex flex-col items-center justify-center gap-2">
                                <div className="bg-blue-100 text-blue-700 p-3 rounded-full"><Icon name="Calendar" /></div>
                                <span className="font-bold text-stone-700">Agenda</span>
                            </button>
                            {/* Acceso directo a mi ministerio */}
                            <button onClick={()=>setActiveTab(profile.ministry === 'Alabanza' ? 'worship' : profile.ministry === 'J√≥venes' ? 'youth' : 'servers')} className="card-elegant p-4 hover:border-brand-300 transition-all flex flex-col items-center justify-center gap-2">
                                <div className="bg-emerald-100 text-emerald-700 p-3 rounded-full"><Icon name="Briefcase" /></div>
                                <span className="font-bold text-stone-700">Mi Ministerio</span>
                            </button>
                        </div>

                        {/* M√©tricas de Rotaci√≥n (Justicia) */}
                        <div className="card-elegant p-6">
                            <h3 className="font-bold text-lg text-stone-800 mb-4">Balance de Servicio (Mes Actual)</h3>
                            <div className="h-64 w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={serviceCount}>
                                        <XAxis dataKey="name" tick={{fontSize:10}} interval={0}/>
                                        <YAxis allowDecimals={false}/>
                                        <RechartsTooltip contentStyle={{borderRadius:'12px', border:'none'}}/>
                                        <Bar dataKey="val" radius={[4,4,0,0]} fill="#be123c" />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                );
            };

            const MessageCenter = () => {
                const [composeOpen, setComposeOpen] = useState(false);
                const [msgForm, setMsgForm] = useState({ to: 'all', content: '' });
                const [openId, setOpenId] = useState(null);
                const [viewContext, setViewContext] = useState(null);

                // Mensajes + Tareas generadas autom√°ticamente de eventos
                const myMessages = messages.filter(m => m.to === 'all' || m.to === profile.id).sort((a,b)=>new Date(b.date)-new Date(a.date));
                
                // Generar "Tareas" basadas en asignaciones en eventos
                const myTasks = [];
                [...worship, ...servers, ...ebd, ...youth].forEach(ev => {
                    const allAssigned = [...Object.values(ev.assignments || {}).flat(), ...Object.values(ev.team || {}).flat()];
                    if(allAssigned.includes(profile.name) && new Date(ev.date) >= new Date()) {
                        myTasks.push({
                            id: ev.id, type: 'assignment', title: `Servicio en ${ev.theme || ev.type}`, 
                            subtitle: ev.date, ministry: ev.src, date: ev.date,
                            details: ev, status: 'Pendiente'
                        });
                    }
                });

                const sendMsg = () => {
                    if(!msgForm.content) return;
                    add('messages', { ...msgForm, from: profile.id, fromName: profile.name, date: new Date().toISOString(), readBy: [] });
                    setComposeOpen(false); setMsgForm({ to: 'all', content: '' });
                };

                const markRead = (msg) => {
                    if(msg.type !== 'assignment' && !msg.readBy?.includes(profile.id)) 
                        update('messages', msg.id, { readBy: [...(msg.readBy||[]), profile.id] });
                };

                return (
                    <div className="max-w-4xl mx-auto space-y-6 animate-enter">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-serif font-bold text-brand-900">Buz√≥n & Tareas</h2>
                            {(profile.role === 'Pastor' || profile.role === 'L√≠der') && (
                                <Button icon="Send" onClick={()=>setComposeOpen(true)}>Redactar</Button>
                            )}
                        </div>

                        <div className="space-y-6">
                            <div>
                                <h3 className="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3">Mis Asignaciones ({myTasks.length})</h3>
                                <div className="space-y-2">
                                    {myTasks.length === 0 && <div className="text-stone-400 text-sm italic">No tienes tareas asignadas.</div>}
                                    {myTasks.map((task, i) => (
                                        <AccordionItem key={i} title={task.title} subtitle={`Fecha: ${formatDate(task.date)}`} status={task.status} meta="Asignaci√≥n"
                                            isOpen={openId === `task-${i}`} onToggle={()=>setOpenId(openId === `task-${i}` ? null : `task-${i}`)}>
                                            <div className="flex flex-col gap-4">
                                                <div className="bg-white p-4 rounded-xl border border-stone-200">
                                                    <p className="font-bold mb-2">Detalles del Evento:</p>
                                                    <p>Horario: {task.details.time}hs</p>
                                                    {task.details.location && <p>Lugar: {task.details.location}</p>}
                                                    {task.details.preacher && <p>Predicador: {task.details.preacher}</p>}
                                                </div>
                                                <Button variant="secondary" onClick={()=>setViewContext(task.details.date)}>Ver Contexto Completo del D√≠a</Button>
                                            </div>
                                        </AccordionItem>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <h3 className="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3">Mensajes ({myMessages.length})</h3>
                                <div className="space-y-2">
                                    {myMessages.map(msg => {
                                        const isRead = msg.readBy?.includes(profile.id);
                                        return (
                                            <AccordionItem key={msg.id} title={msg.fromName} subtitle={formatDate(msg.date)} status={isRead ? 'Le√≠do' : 'Nuevo'} meta="Mensaje"
                                                isOpen={openId === msg.id} onToggle={()=>{setOpenId(openId === msg.id ? null : msg.id); markRead(msg);}}>
                                                <p className="whitespace-pre-wrap">{msg.content}</p>
                                            </AccordionItem>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>

                        <Modal isOpen={composeOpen} onClose={()=>setComposeOpen(false)} title="Enviar Mensaje">
                            <div className="space-y-4">
                                <div><label className="label-ui">Destinatario</label>
                                <select className="input-ui" value={msgForm.to} onChange={e=>setMsgForm({...msgForm, to:e.target.value})}>
                                    <option value="all">Toda la Iglesia</option>
                                    {members.map(m=><option key={m.id} value={m.id}>{m.name}</option>)}
                                </select></div>
                                <div><label className="label-ui">Mensaje</label>
                                <textarea rows="4" className="input-ui" value={msgForm.content} onChange={e=>setMsgForm({...msgForm, content:e.target.value})}></textarea></div>
                                <Button onClick={sendMsg} className="w-full">Enviar</Button>
                            </div>
                        </Modal>

                        {/* Modal Contexto */}
                        <Modal isOpen={!!viewContext} onClose={()=>setViewContext(null)} title={`Contexto: ${formatDate(viewContext)}`}>
                            {viewContext && getFullEventDetails(viewContext).map((ev, i) => (
                                <div key={i} className={`p-4 rounded-xl mb-2 border ${ev.color}`}>
                                    <div className="font-bold">{ev.src} - {ev.time}hs</div>
                                    <div>{ev.theme || ev.title}</div>
                                    <div className="text-xs mt-2 opacity-75">
                                        Asignados: {[...Object.values(ev.assignments||{}).flat(), ...Object.values(ev.team||{}).flat()].join(', ')}
                                    </div>
                                </div>
                            ))}
                        </Modal>
                    </div>
                );
            };

            const UnifiedManager = ({ ministry, collection, data }) => {
                const [date, setDate] = useState(new Date());
                const [modalOpen, setModalOpen] = useState(false);
                const [editing, setEditing] = useState(null);
                const [form, setForm] = useState({});
                const [tab, setTab] = useState('events'); // events | songs (solo alabanza)

                // Filtro Mes
                const monthData = data.filter(d => d.date.startsWith(date.toISOString().slice(0,7))).sort((a,b)=>new Date(a.date)-new Date(b.date));
                
                const changeMonth = (d) => { const n = new Date(date); n.setMonth(n.getMonth()+d); setDate(n); };

                const openEdit = (item=null) => {
                    setEditing(item);
                    setForm(item || { date: '', time: '', type: 'Culto', theme: '', assignments: {}, team: {} }); // Reset form
                    setModalOpen(true);
                };

                const save = () => {
                    if(editing) update(collection, editing.id, form);
                    else add(collection, form);
                    setModalOpen(false);
                };

                // Componente Biblioteca Canciones
                const SongLibrary = () => {
                    const [songModal, setSongModal] = useState(false);
                    const [songForm, setSongForm] = useState({});
                    const filteredSongs = songs.sort((a,b)=>a.title.localeCompare(b.title));

                    const saveSong = () => {
                        if(songForm.id) update('songs', songForm.id, songForm);
                        else add('songs', songForm);
                        setSongModal(false);
                    };

                    return (
                        <div className="space-y-4">
                            <div className="flex justify-between"><h3 className="font-bold">Biblioteca ({songs.length})</h3> <Button icon="Plus" onClick={()=>{setSongForm({}); setSongModal(true)}}>Nueva</Button></div>
                            <div className="grid gap-2">
                                {filteredSongs.map(s => (
                                    <div key={s.id} onClick={()=>{setSongForm(s); setSongModal(true)}} className="bg-white p-3 rounded-xl border border-stone-200 cursor-pointer hover:border-brand-300">
                                        <div className="font-bold text-brand-700">{s.title}</div>
                                        <div className="text-xs text-stone-500">Tono: {s.key} ‚Ä¢ Orden: {s.order || 'N/A'}</div>
                                    </div>
                                ))}
                            </div>
                            <Modal isOpen={songModal} onClose={()=>setSongModal(false)} title="Editar Canci√≥n">
                                <div className="space-y-3">
                                    <input className="input-ui" placeholder="T√≠tulo" value={songForm.title||''} onChange={e=>setSongForm({...songForm, title:e.target.value})}/>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="input-ui" placeholder="Tono (Ej: G)" value={songForm.key||''} onChange={e=>setSongForm({...songForm, key:e.target.value})}/>
                                        <input className="input-ui" placeholder="Orden/Secuencia" value={songForm.order||''} onChange={e=>setSongForm({...songForm, order:e.target.value})}/>
                                    </div>
                                    <textarea className="input-ui font-mono text-xs" rows="10" placeholder="Letra / Cifrado" value={songForm.lyrics||''} onChange={e=>setSongForm({...songForm, lyrics:e.target.value})}></textarea>
                                    <Button onClick={saveSong} className="w-full">Guardar Canci√≥n</Button>
                                    {songForm.id && <Button variant="danger" onClick={()=>{del('songs', songForm.id); setSongModal(false)}} className="w-full mt-2">Eliminar</Button>}
                                </div>
                            </Modal>
                        </div>
                    )
                };

                return (
                    <div className="animate-enter space-y-6">
                        <div className="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                            <div className="flex items-center gap-4">
                                <button onClick={()=>changeMonth(-1)} className="p-2 bg-stone-100 rounded-lg hover:bg-stone-200"><Icon name="ChevronLeft"/></button>
                                <span className="font-serif font-bold text-xl w-40 text-center">{formatDate(date, 'month')}</span>
                                <button onClick={()=>changeMonth(1)} className="p-2 bg-stone-100 rounded-lg hover:bg-stone-200"><Icon name="ChevronRight"/></button>
                            </div>
                            {ministry === 'Alabanza' && (
                                <div className="flex bg-stone-100 p-1 rounded-lg">
                                    <button onClick={()=>setTab('events')} className={`px-4 py-1 rounded-md text-sm font-bold transition-all ${tab==='events'?'bg-white shadow text-brand-700':'text-stone-500'}`}>Eventos</button>
                                    <button onClick={()=>setTab('songs')} className={`px-4 py-1 rounded-md text-sm font-bold transition-all ${tab==='songs'?'bg-white shadow text-brand-700':'text-stone-500'}`}>Canciones</button>
                                </div>
                            )}
                            {canEdit(profile, ministry) && tab === 'events' && <Button icon="Plus" onClick={()=>openEdit()}>Planificar</Button>}
                        </div>

                        {tab === 'songs' ? <SongLibrary /> : (
                            <div className="grid gap-4">
                                {monthData.length === 0 && <div className="text-center py-10 text-stone-400 border-2 border-dashed rounded-2xl">Sin actividades este mes</div>}
                                {monthData.map(item => (
                                    <div key={item.id} className="card-elegant p-0 overflow-hidden relative group">
                                        <div className="flex flex-col md:flex-row">
                                            <div className="bg-brand-50 p-4 w-full md:w-24 flex md:flex-col items-center justify-center gap-2 border-r border-brand-100 text-brand-800">
                                                <span className="text-3xl font-serif font-bold">{new Date(item.date).getDate()}</span>
                                                <span className="text-xs font-bold uppercase">{formatDate(item.date).split(' ')[0]}</span>
                                            </div>
                                            <div className="p-4 flex-1">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <span className="bg-stone-800 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase">{item.type}</span>
                                                        <h3 className="font-bold text-lg text-stone-800 mt-1">{item.theme || item.title || 'Actividad General'}</h3>
                                                        <p className="text-stone-500 text-sm flex gap-2 mt-1">
                                                            <span>‚è∞ {item.time}hs</span>
                                                            {item.preacher && <span>üé§ {item.preacher}</span>}
                                                        </p>
                                                    </div>
                                                    {canEdit(profile, ministry) && (
                                                        <button onClick={()=>openEdit(item)} className="p-2 bg-stone-100 text-stone-600 rounded-lg hover:bg-brand-50 hover:text-brand-600 transition-colors"><Icon name="Edit" size={16}/></button>
                                                    )}
                                                </div>
                                                
                                                {/* Asignaciones Din√°micas Multi-User */}
                                                <div className="mt-4 flex flex-wrap gap-2">
                                                    {[...Object.entries(item.assignments||{}), ...Object.entries(item.team||{})].map(([k,v]) => (
                                                        v && v.length > 0 && (
                                                            <div key={k} className="bg-stone-50 border border-stone-200 px-2 py-1 rounded text-xs text-stone-600">
                                                                <strong className="text-brand-700 capitalize">{k}:</strong> {v.join(', ')}
                                                            </div>
                                                        )
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        <Modal isOpen={modalOpen} onClose={()=>setModalOpen(false)} title="Planificaci√≥n">
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="label-ui">Fecha</label><input type="date" className="input-ui" value={form.date} onChange={e=>setForm({...form, date:e.target.value})}/></div>
                                    <div><label className="label-ui">Hora</label><input type="time" className="input-ui" value={form.time} onChange={e=>setForm({...form, time:e.target.value})}/></div>
                                </div>
                                <div><label className="label-ui">Tema / T√≠tulo</label><input className="input-ui" value={form.theme || form.title} onChange={e=>setForm({...form, theme:e.target.value, title:e.target.value})}/></div>
                                
                                {collection === 'servers' && (
                                    <div><label className="label-ui">Predicador</label><input className="input-ui" value={form.preacher||''} onChange={e=>setForm({...form, preacher:e.target.value})}/></div>
                                )}

                                <div className="border-t pt-4">
                                    <h4 className="font-bold text-brand-900 mb-3">Asignaciones (Multi-selecci√≥n)</h4>
                                    {/* Generador de campos seg√∫n colecci√≥n */}
                                    {(collection === 'worship' ? ['Vocal', 'Guitarra', 'Bajo', 'Bater√≠a', 'Teclado'] 
                                      : collection === 'servers' ? ['Recepci√≥n', 'Ba√±os', 'Altar', 'Ofrenda', 'Seguridad']
                                      : ['L√≠der', 'Colaborador', 'Log√≠stica']).map(role => (
                                        <MultiSelect key={role} label={role} options={members} 
                                            selected={collection === 'worship' ? (form.team?.[role]||[]) : (form.assignments?.[role]||[])}
                                            onChange={(vals) => {
                                                if(collection==='worship') setForm({...form, team: {...form.team, [role]: vals}});
                                                else setForm({...form, assignments: {...form.assignments, [role]: vals}});
                                            }}
                                        />
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <Button onClick={save} className="flex-1">Guardar</Button>
                                    {editing && <Button variant="danger" onClick={()=>del(collection, editing.id)}>Eliminar</Button>}
                                </div>
                            </div>
                        </Modal>
                    </div>
                );
            };

            const FinanceManager = () => {
                const [date, setDate] = useState(new Date());
                const [modal, setModal] = useState(false);
                const [form, setForm] = useState({ type: 'Culto', date: '', tithes: '', offerings: '', cash: '', notes: '' });

                const monthData = finances.filter(f => f.date.startsWith(date.toISOString().slice(0, 7)));
                const stats = monthData.reduce((acc, curr) => {
                    const t = Number(curr.tithes)||0;
                    const o = Number(curr.offerings)||0;
                    const c = Number(curr.cash)||0;
                    const tot = curr.total || (t+o+c);
                    return { ...acc, ing: acc.ing + (tot>0?tot:0), gas: acc.gas + (tot<0?Math.abs(tot):0) };
                }, { ing: 0, gas: 0 });

                const save = () => {
                    let total = 0;
                    if(form.type === 'Culto') total = Number(form.tithes) + Number(form.offerings);
                    else if(form.type === 'Gasto') total = -Math.abs(Number(form.cash));
                    else total = Number(form.cash);
                    
                    add('finances', { ...form, total, tithes:Number(form.tithes), offerings:Number(form.offerings), cash:Number(form.cash) });
                    setModal(false);
                };

                return (
                    <div className="animate-enter space-y-6">
                        <div className="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                             <div className="flex items-center gap-4">
                                <button onClick={()=>{const d=new Date(date); d.setMonth(d.getMonth()-1); setDate(d)}} className="p-2 bg-stone-100 rounded-lg"><Icon name="ChevronLeft"/></button>
                                <span className="font-serif font-bold text-xl">{formatDate(date, 'month')}</span>
                                <button onClick={()=>{const d=new Date(date); d.setMonth(d.getMonth()+1); setDate(d)}} className="p-2 bg-stone-100 rounded-lg"><Icon name="ChevronRight"/></button>
                            </div>
                            <Button icon="Plus" onClick={()=>{setForm({type:'Culto', tithes:'', offerings:'', cash:'', date:''}); setModal(true)}}>Registrar</Button>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="p-6 bg-emerald-100 text-emerald-900 rounded-2xl">
                                <p className="text-xs font-bold uppercase opacity-70">Ingresos Totales</p>
                                <p className="text-3xl font-bold mt-1">{formatMoney(stats.ing)}</p>
                            </div>
                            <div className="p-6 bg-red-100 text-red-900 rounded-2xl">
                                <p className="text-xs font-bold uppercase opacity-70">Gastos Totales</p>
                                <p className="text-3xl font-bold mt-1">{formatMoney(stats.gas)}</p>
                            </div>
                            <div className="p-6 bg-stone-800 text-white rounded-2xl">
                                <p className="text-xs font-bold uppercase opacity-70">Balance</p>
                                <p className="text-3xl font-bold mt-1">{formatMoney(stats.ing - stats.gas)}</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-2xl border border-stone-100 overflow-hidden">
                            <table className="w-full text-sm">
                                <thead className="bg-stone-50 text-stone-400 font-bold uppercase text-xs">
                                    <tr><th className="p-4 text-left">Fecha</th><th className="p-4 text-left">Concepto</th><th className="p-4 text-right">Monto</th></tr>
                                </thead>
                                <tbody>
                                    {monthData.map(f => (
                                        <tr key={f.id} className="border-t border-stone-50">
                                            <td className="p-4 font-bold">{formatDate(f.date)}</td>
                                            <td className="p-4">
                                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded mr-2 uppercase ${f.type==='Gasto'?'bg-red-100 text-red-700':'bg-emerald-100 text-emerald-700'}`}>{f.type}</span>
                                                {f.notes}
                                                {f.type==='Culto' && <div className="text-xs text-stone-400 mt-1">Diezmos: {formatMoney(f.tithes)} | Ofrendas: {formatMoney(f.offerings)}</div>}
                                            </td>
                                            <td className={`p-4 text-right font-mono font-bold ${f.total<0?'text-red-500':'text-emerald-600'}`}>{formatMoney(f.total)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <Modal isOpen={modal} onClose={()=>setModal(false)} title="Nuevo Movimiento">
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="label-ui">Tipo</label><select className="input-ui" value={form.type} onChange={e=>setForm({...form, type:e.target.value})}><option>Culto</option><option>Ingreso</option><option>Gasto</option></select></div>
                                    <div><label className="label-ui">Fecha</label><input type="date" className="input-ui" value={form.date} onChange={e=>setForm({...form, date:e.target.value})}/></div>
                                </div>
                                {form.type === 'Culto' ? (
                                    <div className="grid grid-cols-2 gap-4 bg-stone-50 p-4 rounded-xl border border-stone-200">
                                        <div><label className="label-ui">Diezmos</label><input type="number" className="input-ui" value={form.tithes} onChange={e=>setForm({...form, tithes:e.target.value})}/></div>
                                        <div><label className="label-ui">Ofrendas</label><input type="number" className="input-ui" value={form.offerings} onChange={e=>setForm({...form, offerings:e.target.value})}/></div>
                                    </div>
                                ) : (
                                    <div><label className="label-ui">Monto</label><input type="number" className="input-ui" value={form.cash} onChange={e=>setForm({...form, cash:e.target.value})}/></div>
                                )}
                                <div><label className="label-ui">Notas</label><input className="input-ui" value={form.notes} onChange={e=>setForm({...form, notes:e.target.value})}/></div>
                                <Button onClick={save} className="w-full">Guardar</Button>
                            </div>
                        </Modal>
                    </div>
                );
            };

            const Directory = () => {
                const [modal, setModal] = useState(false);
                const [form, setForm] = useState({});

                const save = () => {
                    if(!form.name || !form.email) return alert("Nombre y Email obligatorios");
                    add('members', {...form, ministry: form.ministry || 'General', role: form.role || 'Miembro', status: 'Activo'});
                    setModal(false);
                };

                return (
                    <div className="animate-enter">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-serif font-bold text-brand-900">Directorio ({members.length})</h2>
                            <Button icon="Plus" onClick={()=>{setForm({}); setModal(true)}}>Nuevo Miembro</Button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {members.map(m => (
                                <div key={m.id} className="bg-white p-4 rounded-xl shadow-soft border border-stone-100 flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-full bg-brand-100 flex items-center justify-center text-brand-700 font-bold text-lg">
                                        {m.name.charAt(0)}
                                    </div>
                                    <div>
                                        <div className="font-bold text-stone-800">{m.name}</div>
                                        <div className="text-xs text-stone-500">{m.role} ‚Ä¢ {m.ministry}</div>
                                        {m.phone && <div className="text-xs text-stone-400 mt-1">üìû {m.phone}</div>}
                                    </div>
                                    {canEdit(profile, 'General') && <button onClick={()=>del('members', m.id)} className="ml-auto text-red-300 hover:text-red-500"><Icon name="Trash" size={16}/></button>}
                                </div>
                            ))}
                        </div>
                        <Modal isOpen={modal} onClose={()=>setModal(false)} title="Agregar Miembro">
                            <div className="space-y-4">
                                <div><label className="label-ui">Nombre Completo</label><input className="input-ui" value={form.name||''} onChange={e=>setForm({...form, name:e.target.value})}/></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="label-ui">Edad</label><input type="number" className="input-ui" value={form.age||''} onChange={e=>setForm({...form, age:e.target.value})}/></div>
                                    <div><label className="label-ui">Tel√©fono</label><input className="input-ui" value={form.phone||''} onChange={e=>setForm({...form, phone:e.target.value})}/></div>
                                </div>
                                <div><label className="label-ui">Email (Login Google)</label><input type="email" className="input-ui" value={form.email||''} onChange={e=>setForm({...form, email:e.target.value})}/></div>
                                <div><label className="label-ui">Direcci√≥n (Opcional)</label><input className="input-ui" value={form.address||''} onChange={e=>setForm({...form, address:e.target.value})}/></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="label-ui">Rol</label><select className="input-ui" value={form.role||'Miembro'} onChange={e=>setForm({...form, role:e.target.value})}><option>Pastor</option><option>L√≠der</option><option>Miembro</option></select></div>
                                    <div><label className="label-ui">Ministerio</label><select className="input-ui" value={form.ministry||'General'} onChange={e=>setForm({...form, ministry:e.target.value})}><option>General</option><option>Alabanza</option><option>Servidores</option><option>Escuela B√≠blica</option><option>J√≥venes</option></select></div>
                                </div>
                                <Button onClick={save} className="w-full">Registrar</Button>
                            </div>
                        </Modal>
                    </div>
                );
            };

            const GlobalCalendar = () => {
                const [date, setDate] = useState(new Date());
                const [selectedDay, setSelectedDay] = useState(null);

                const daysInMonth = new Date(date.getFullYear(), date.getMonth()+1, 0).getDate();
                const startDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
                const days = Array.from({length: daysInMonth}, (_,i)=>i+1);

                return (
                    <div className="h-full flex flex-col animate-enter">
                         <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-serif font-bold text-brand-900">Agenda Global</h2>
                            <div className="flex items-center gap-4 bg-white p-2 rounded-xl border border-stone-200">
                                <button onClick={()=>{const d=new Date(date); d.setMonth(d.getMonth()-1); setDate(d)}}><Icon name="ChevronLeft"/></button>
                                <span className="font-bold w-32 text-center">{formatDate(date, 'month')}</span>
                                <button onClick={()=>{const d=new Date(date); d.setMonth(d.getMonth()+1); setDate(d)}}><Icon name="ChevronRight"/></button>
                            </div>
                        </div>
                        <div className="bg-white rounded-3xl shadow-soft p-6 flex-1 flex flex-col">
                            <div className="grid grid-cols-7 mb-2 text-center font-bold text-stone-300 uppercase text-xs">
                                {['D','L','M','M','J','V','S'].map(d=><div key={d}>{d}</div>)}
                            </div>
                            <div className="grid grid-cols-7 flex-1 auto-rows-fr gap-2">
                                {Array(startDay).fill(null).map((_,i)=><div key={`empty-${i}`}></div>)}
                                {days.map(d => {
                                    const dStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                    const events = getFullEventDetails(dStr);
                                    return (
                                        <div key={d} onClick={()=>{if(events.length) setSelectedDay(dStr)}} 
                                            className={`rounded-xl border p-2 relative cursor-pointer hover:bg-brand-50 transition-colors flex flex-col justify-between ${events.length?'border-brand-200 bg-brand-50/30':'border-stone-100'}`}>
                                            <span className={`font-bold text-sm ${new Date().toISOString().startsWith(dStr)?'text-brand-600':''}`}>{d}</span>
                                            <div className="flex flex-wrap gap-1 content-end">
                                                {events.map((ev,i) => <div key={i} className={`w-2 h-2 rounded-full ${ev.src==='Alabanza'?'bg-purple-500':ev.src==='Servidores'?'bg-blue-500':'bg-orange-500'}`}></div>)}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                        <Modal isOpen={!!selectedDay} onClose={()=>setSelectedDay(null)} title={`Eventos: ${formatDate(selectedDay)}`}>
                            {selectedDay && getFullEventDetails(selectedDay).map((ev, i) => (
                                <div key={i} className="mb-4 bg-stone-50 p-4 rounded-xl border border-stone-200">
                                    <div className="flex justify-between font-bold text-lg"><span>{ev.theme || ev.title}</span><span className="text-sm bg-white px-2 rounded border">{ev.src}</span></div>
                                    <div className="text-sm text-stone-500 mb-2">{ev.time}hs ‚Ä¢ {ev.location || 'Templo'}</div>
                                    {ev.preacher && <div className="text-sm">üé§ Predica: {ev.preacher}</div>}
                                    <div className="mt-3 pt-3 border-t border-stone-200 text-xs text-stone-600">
                                        <p className="font-bold uppercase mb-1 text-stone-400">Equipo:</p>
                                        {[...Object.values(ev.assignments||{}).flat(), ...Object.values(ev.team||{}).flat()].join(', ')}
                                    </div>
                                </div>
                            ))}
                        </Modal>
                    </div>
                );
            };

            // RENDER PRINCIPAL
            if (!user) return (
                <div className="min-h-screen flex items-center justify-center bg-cream">
                    <div className="text-center space-y-6 p-8 max-w-md w-full">
                        <div className="bg-brand-700 w-24 h-24 rounded-full mx-auto flex items-center justify-center text-white shadow-glow animate-enter">
                            <Icon name="Home" size={48}/>
                        </div>
                        <h1 className="text-4xl font-serif font-bold text-brand-900">Conquistadores</h1>
                        <p className="text-stone-500">Plataforma de gesti√≥n ministerial</p>
                        <Button onClick={()=>auth.signInWithPopup(googleProvider)} className="w-full py-4 text-lg">Ingresar con Google</Button>
                    </div>
                </div>
            );

            if (!profile) return <div className="h-screen flex items-center justify-center text-brand-700">Cargando perfil...</div>;

            return (
                <div className="flex h-screen bg-cream overflow-hidden font-sans text-stone-800">
                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-stone-100 transform transition-transform duration-300 md:relative md:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-8 h-full flex flex-col">
                            <div className="flex items-center gap-3 mb-10 text-brand-800">
                                <Icon name="Home" size={28}/> <span className="font-serif font-bold text-2xl">CDS App</span>
                            </div>
                            <nav className="space-y-1 flex-1 overflow-y-auto hide-scroll">
                                <MenuBtn active={activeTab} id="dashboard" icon="Home" label="Inicio" set={setActiveTab}/>
                                <MenuBtn active={activeTab} id="messages" icon="Mail" label="Buz√≥n" set={setActiveTab} badge={messages.filter(m=>(m.to==='all'||m.to===profile.id)&&!m.readBy?.includes(profile.id)).length}/>
                                <MenuBtn active={activeTab} id="calendar" icon="Calendar" label="Agenda Global" set={setActiveTab}/>
                                <div className="py-4 text-xs font-bold text-stone-400 uppercase tracking-widest">Ministerios</div>
                                <MenuBtn active={activeTab} id="worship" icon="Music" label="Alabanza" set={setActiveTab}/>
                                <MenuBtn active={activeTab} id="servers" icon="Briefcase" label="Servidores" set={setActiveTab}/>
                                <MenuBtn active={activeTab} id="ebd" icon="BookOpen" label="Escuela B√≠blica" set={setActiveTab}/>
                                <MenuBtn active={activeTab} id="youth" icon="Smile" label="J√≥venes" set={setActiveTab}/>
                                {profile.role === 'Pastor' && (
                                    <>
                                        <div className="py-4 text-xs font-bold text-stone-400 uppercase tracking-widest">Admin</div>
                                        <MenuBtn active={activeTab} id="finances" icon="DollarSign" label="Tesorer√≠a" set={setActiveTab}/>
                                        <MenuBtn active={activeTab} id="directory" icon="Users" label="Directorio" set={setActiveTab}/>
                                    </>
                                )}
                            </nav>
                            <div className="pt-4 border-t flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center font-bold text-brand-700 text-xs">{profile.name.charAt(0)}</div>
                                    <div className="text-xs leading-tight"><p className="font-bold">{profile.name.split(' ')[0]}</p><p className="text-stone-400">{profile.role}</p></div>
                                </div>
                                <button onClick={()=>auth.signOut()} className="text-stone-400 hover:text-red-500"><Icon name="LogOut"/></button>
                            </div>
                        </div>
                    </aside>

                    {/* Main */}
                    <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        <header className="md:hidden bg-white/80 backdrop-blur p-4 border-b flex justify-between items-center sticky top-0 z-20">
                            <span className="font-serif font-bold text-xl text-brand-800">Conquistadores</span>
                            <button onClick={()=>setSidebarOpen(true)}><Icon name="Menu"/></button>
                        </header>
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 pb-24 max-w-7xl mx-auto w-full">
                            {activeTab === 'dashboard' && <Dashboard />}
                            {activeTab === 'messages' && <MessageCenter />}
                            {activeTab === 'calendar' && <GlobalCalendar />}
                            {activeTab === 'worship' && <UnifiedManager ministry="Alabanza" collection="worship" data={worship} />}
                            {activeTab === 'servers' && <UnifiedManager ministry="Servidores" collection="servers" data={servers} />}
                            {activeTab === 'ebd' && <UnifiedManager ministry="Escuela B√≠blica" collection="ebd" data={ebd} />}
                            {activeTab === 'youth' && <UnifiedManager ministry="J√≥venes" collection="youth" data={youth} />}
                            {activeTab === 'finances' && <FinanceManager />}
                            {activeTab === 'directory' && <Directory />}
                        </div>
                        {/* FAB */}
                        <div className="absolute bottom-6 right-6">
                            <button onClick={()=>setQuickActionOpen(true)} className="bg-brand-600 text-white p-4 rounded-2xl shadow-glow hover:scale-105 transition-transform flex items-center gap-2 font-bold">
                                <Icon name="Plus"/> <span className="hidden md:inline">Acci√≥n R√°pida</span>
                            </button>
                        </div>
                    </main>

                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={()=>setSidebarOpen(false)}></div>}
                    
                    {/* Quick Action Modal */}
                    <Modal isOpen={quickActionOpen} onClose={()=>setQuickActionOpen(false)} title="¬øQu√© deseas hacer?">
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={()=>{setActiveTab('worship'); setQuickActionOpen(false)}} className="p-4 bg-purple-50 text-purple-700 rounded-xl font-bold flex flex-col items-center gap-2 hover:bg-purple-100"><Icon name="Music"/> Planificar Alabanza</button>
                            <button onClick={()=>{setActiveTab('servers'); setQuickActionOpen(false)}} className="p-4 bg-blue-50 text-blue-700 rounded-xl font-bold flex flex-col items-center gap-2 hover:bg-blue-100"><Icon name="Briefcase"/> Planificar Servidores</button>
                            <button onClick={()=>{setActiveTab('messages'); setQuickActionOpen(false)}} className="p-4 bg-amber-50 text-amber-700 rounded-xl font-bold flex flex-col items-center gap-2 hover:bg-amber-100"><Icon name="Mail"/> Enviar Mensaje</button>
                            {profile.role === 'Pastor' && <button onClick={()=>{setActiveTab('finances'); setQuickActionOpen(false)}} className="p-4 bg-emerald-50 text-emerald-700 rounded-xl font-bold flex flex-col items-center gap-2 hover:bg-emerald-100"><Icon name="DollarSign"/> Registrar Finanza</button>}
                        </div>
                    </Modal>
                </div>
            );
        };

        const MenuBtn = ({active, id, icon, label, set, badge}) => (
            <button onClick={()=>set(id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all mb-1 ${active===id ? 'bg-brand-50 text-brand-700' : 'text-stone-500 hover:bg-stone-50 hover:text-stone-800'}`}>
                <Icon name={icon} /> {label}
                {badge > 0 && <span className="ml-auto bg-brand-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">{badge}</span>}
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
