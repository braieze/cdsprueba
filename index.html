<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Conquistadores v3.0</title>
    
    <!-- Scripts Base -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LibrerÃ­a de GrÃ¡ficos -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    
    <!-- Fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50:'#fff7ed', 100:'#ffedd5', 500:'#f97316', 600:'#ea580c', 700:'#c2410c', 900:'#7c2d12' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const RechartsObj = window.Recharts || {};
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = RechartsObj;
        const chartsAvailable = !!window.Recharts;

        // --- ICONOS ---
        const Icons = {
            Home: <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>,
            Users: <React.Fragment><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></React.Fragment>,
            Wallet: <React.Fragment><path d="M20 12V8H6a2 2 0 0 1 0-4h14v4"/><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"/><path d="M18 12a2 2 0 0 0 0 4h4v-4z"/></React.Fragment>,
            Music: <React.Fragment><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></React.Fragment>,
            Book: <React.Fragment><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></React.Fragment>,
            Smile: <React.Fragment><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></React.Fragment>,
            Bell: <React.Fragment><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></React.Fragment>,
            Calendar: <React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></React.Fragment>,
            LogOut: <React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></React.Fragment>,
            Plus: <React.Fragment><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></React.Fragment>,
            X: <React.Fragment><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></React.Fragment>,
            Menu: <React.Fragment><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></React.Fragment>,
            Search: <React.Fragment><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></React.Fragment>,
            Mail: <React.Fragment><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></React.Fragment>,
            ChevronRight: <polyline points="9 18 15 12 9 6"/>,
            Trash: <React.Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></React.Fragment>,
            Edit: <React.Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></React.Fragment>,
            UserCheck: <React.Fragment><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></React.Fragment>,
            Bank: <React.Fragment><path d="M3 21h18"/><path d="M5 21v-7"/><path d="M19 21v-7"/><path d="M10 21v-4a2 2 0 0 1 4 0v4"/><polyline points="2 7 12 2 22 7"/><path d="M3 7v5a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V7"/></React.Fragment>
        };

        const Icon = ({ name, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {Icons[name] || <circle cx="12" cy="12" r="10"/>}
            </svg>
        );

        // --- HELPER FUNCTIONS ---
        const formatDate = (dateStr) => {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('es-AR', { day: 'numeric', month: 'short' });
        };

        const formatCurrency = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(val);

        // --- DATOS INICIALES ---
        const INITIAL_DATA = {
            members: [
                { id: 1, name: 'Pastor Roberto', role: 'Pastor', ministry: 'Pastoral', phone: '11-5555-0001', photo: 'https://ui-avatars.com/api/?name=Roberto+Perez&background=0d9488&color=fff', status: 'Activo', birth: '1975-05-20', visitHistory: [] },
                { id: 2, name: 'Lucas Diaz', role: 'LÃ­der', ministry: 'Alabanza', phone: '11-5555-0002', photo: 'https://ui-avatars.com/api/?name=Lucas+Diaz&background=ea580c&color=fff', status: 'Activo', birth: '1995-03-15', visitHistory: [{date: '2023-11-20', note: 'Entregada llave de ensayo', rating: 'Buena'}] },
                { id: 3, name: 'Sofia M.', role: 'LÃ­der', ministry: 'EBD', phone: '11-5555-0003', photo: 'https://ui-avatars.com/api/?name=Sofia+M&background=0891b2&color=fff', status: 'Activo', birth: '1990-08-10', visitHistory: [] },
                { id: 4, name: 'Javier K.', role: 'LÃ­der', ministry: 'JÃ³venes', phone: '11-5555-0004', photo: 'https://ui-avatars.com/api/?name=Javier+K&background=7c3aed&color=fff', status: 'Activo', birth: '2000-12-01', visitHistory: [] },
                { id: 5, name: 'Maria Gomez', role: 'Miembro', ministry: 'General', phone: '11-5555-0005', photo: 'https://ui-avatars.com/api/?name=Maria+G&background=64748b&color=fff', status: 'Activo', birth: '1985-02-14', visitHistory: [{date: '2023-10-15', note: 'Visita pastoral rutinaria', rating: 'Regular'}] },
                { id: 6, name: 'Tomas Joven', role: 'Miembro', ministry: 'JÃ³venes', phone: '11-5555-0006', photo: 'https://ui-avatars.com/api/?name=Tomas+J&background=random', status: 'Activo', birth: '2005-06-20', visitHistory: [] },
                { id: 7, name: 'Pedro Server', role: 'Servidor', ministry: 'JÃ³venes', phone: '11-5555-0007', photo: 'https://ui-avatars.com/api/?name=Pedro+S&background=random', status: 'Activo', birth: '2002-01-10', visitHistory: [] },
            ],
            finances: [
                { id: 1, date: '2023-11-26', type: 'Culto', cash: 45000, transfer: 32000, tithesCount: 15, notes: 'Culto Dominical' },
                { id: 2, date: '2023-11-19', type: 'Culto', cash: 38000, transfer: 28000, tithesCount: 12, notes: 'Culto Dominical' },
                { id: 3, date: '2023-11-28', type: 'Gasto', cash: -5000, transfer: 0, tithesCount: 0, notes: 'Compra ArtÃ­culos Limpieza' },
                { id: 4, date: '2023-11-30', type: 'Ingreso', cash: 0, transfer: 15000, tithesCount: 0, notes: 'DonaciÃ³n AnÃ³nima' },
            ],
            worship: [
                { id: 1, date: '2023-12-03', type: 'Culto', theme: 'Domingo de Victoria', songs: ['Tu Fidelidad', 'Cuerdas de Amor', 'Digno'], team: { Vocal: ['Lucas Diaz', 'Sofia M.'], Guitarra: ['Lucas Diaz'], Bateria: [], Bajo: [] } },
                { id: 2, date: '2023-12-01', type: 'Ensayo', theme: 'Ensayo General', songs: ['Repertorio Domingo'], team: { Vocal: ['Lucas Diaz'], Guitarra: ['Lucas Diaz'], Bateria: [], Bajo: [] } },
                { id: 3, date: '2023-12-10', type: 'Culto', theme: 'Navidad Anticipada', songs: ['Noche de Paz', 'Vino Celestial'], team: { Vocal: ['Lucas Diaz'], Guitarra: [], Bateria: [], Bajo: [] } }
            ],
            ebd: [
                { id: 1, date: '2023-12-03', topic: 'La CreaciÃ³n', teachers: ['Sofia M.'], students: 15 },
                { id: 2, date: '2023-12-10', topic: 'El Arca de NoÃ©', teachers: ['Sofia M.'], students: 0 }
            ],
            youth: [
                { id: 1, date: '2023-12-02', title: 'Noche de Cine', location: 'SUM Iglesia', notes: 'Traer refrescos' }
            ],
            youthTasks: [
                { id: 1, task: 'Comprar Hielo', assignee: 'Pedro Server', status: 'Pendiente' },
                { id: 2, task: 'Armar Playlist', assignee: 'Tomas Joven', status: 'Completado' }
            ],
            messages: [
                { id: 1, from: 'Pastor Roberto', to: 'LÃ­deres', content: 'ReuniÃ³n de planificaciÃ³n este sÃ¡bado 18hs.', date: '2023-11-28' },
                { id: 2, from: 'Sistema', to: 'Todos', content: 'Recordatorio: Ensayo general viernes 20hs.', date: '2023-11-27' }
            ]
        };

        // --- UI COMPONENTS ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 p-6 ${className}`}>{children}</div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                            <h3 className="text-xl font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><Icon name="X" /></button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        const Badge = ({ children, type = 'default' }) => {
            const styles = {
                default: "bg-slate-100 text-slate-600",
                success: "bg-emerald-100 text-emerald-700",
                warning: "bg-amber-100 text-amber-700",
                danger: "bg-red-100 text-red-700",
                brand: "bg-brand-100 text-brand-700",
                blue: "bg-blue-100 text-blue-700"
            };
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide ${styles[type] || styles.default}`}>{children}</span>;
        };

        const Button = ({ children, onClick, variant = 'primary', className = "", icon }) => {
            const variants = {
                primary: "bg-brand-600 text-white hover:bg-brand-700 shadow-lg shadow-brand-500/30",
                secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50",
                danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100"
            };
            return (
                <button onClick={onClick} className={`flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl font-semibold transition-all active:scale-95 ${variants[variant]} ${className}`}>
                    {icon && <Icon name={icon} size={18} />}
                    {children}
                </button>
            );
        };

        // --- MODULES ---

        // 1. DASHBOARD
        const Dashboard = ({ user, data }) => {
            const myServices = useMemo(() => {
                const services = [];
                // Alabanza
                data.worship.forEach(s => {
                    const isVocal = s.team.Vocal.includes(user.name);
                    const isGuitar = s.team.Guitarra.includes(user.name);
                    const isTeam = Object.values(s.team).flat().includes(user.name);
                    if (isTeam || user.ministry === 'Alabanza') {
                        services.push({ ...s, area: 'Alabanza', role: isVocal ? 'Vocal' : (isGuitar ? 'Guitarra' : 'Equipo'), title: s.theme });
                    }
                });
                // EBD
                data.ebd.forEach(c => {
                    if (c.teachers.includes(user.name) || user.ministry === 'EBD') services.push({ ...c, area: 'EBD', title: c.topic, role: 'Maestro' });
                });
                // Tareas JÃ³venes
                data.youthTasks.forEach(t => {
                     if (t.assignee === user.name) services.push({ id: t.id, date: new Date().toISOString().split('T')[0], area: 'JÃ³venes', title: t.task, role: 'Colaborador', isTask: true });
                });
                
                return services.sort((a,b) => new Date(a.date) - new Date(b.date)).filter(s => s.isTask || new Date(s.date) >= new Date());
            }, [data, user]);

            const totalBalance = data.finances.reduce((acc, curr) => acc + curr.cash + curr.transfer, 0);

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-800">Hola, {user.name.split(' ')[0]} ðŸ‘‹</h2>
                            <p className="text-slate-500 font-medium">Panel de {user.role}</p>
                        </div>
                        {user.role === 'Pastor' && (
                            <div className="flex gap-4">
                                <div className="bg-white p-2 pr-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                                    <div className="bg-emerald-100 p-3 rounded-xl text-emerald-600"><Icon name="Wallet" /></div>
                                    <div>
                                        <p className="text-xs font-bold text-slate-400 uppercase">Total en Caja</p>
                                        <p className="text-xl font-bold text-slate-800">{formatCurrency(totalBalance)}</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <Card className="border-l-4 border-l-brand-500 bg-gradient-to-r from-brand-50 to-white">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="Bell" size={18} className="text-brand-600"/> TUS PRÃ“XIMOS SERVICIOS</h3>
                        </div>
                        {myServices.length > 0 ? (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {myServices.slice(0,3).map((s, i) => (
                                    <div key={i} className="bg-white p-3 rounded-xl border border-brand-100 shadow-sm flex flex-col gap-1 relative overflow-hidden">
                                        {s.isTask && <div className="absolute right-0 top-0 bg-yellow-100 text-yellow-800 text-[10px] px-2 py-0.5 rounded-bl-lg font-bold">TAREA</div>}
                                        <div className="flex justify-between">
                                            <Badge type="brand">{s.area}</Badge>
                                            <span className="text-xs font-bold text-slate-400">{s.isTask ? 'Pendiente' : formatDate(s.date)}</span>
                                        </div>
                                        <p className="font-bold text-sm text-slate-800 truncate">{s.title}</p>
                                        <p className="text-xs text-slate-500">Rol: {s.role}</p>
                                    </div>
                                ))}
                            </div>
                        ) : <p className="text-slate-500 italic text-sm">No tienes servicios asignados prÃ³ximamente.</p>}
                    </Card>
                    
                    {/* Lista resumen de calendario solo en Home (Como lista) */}
                    <Card>
                        <h3 className="font-bold mb-4 flex items-center gap-2"><Icon name="Calendar"/> PrÃ³ximos Eventos</h3>
                        <div className="space-y-3">
                            {[...data.worship, ...data.ebd, ...data.youth]
                                .filter(e => new Date(e.date) >= new Date())
                                .sort((a,b) => new Date(a.date) - new Date(b.date))
                                .slice(0, 5)
                                .map((e, i) => (
                                    <div key={i} className="flex gap-3 items-center border-b border-slate-100 pb-2 last:border-0 last:pb-0">
                                        <div className="bg-slate-100 p-2 rounded text-center min-w-[3.5rem]">
                                            <span className="block text-xl font-bold leading-none">{new Date(e.date+'T00:00:00').getDate()}</span>
                                            <span className="text-[10px] uppercase text-slate-400">{new Date(e.date+'T00:00:00').toLocaleDateString('es-AR', {month:'short'})}</span>
                                        </div>
                                        <div>
                                            <p className="font-semibold text-sm truncate">{e.theme || e.topic || e.title}</p>
                                            <p className="text-xs text-slate-400">{e.type || (e.topic ? 'Clase EBD' : 'JÃ³venes')}</p>
                                        </div>
                                    </div>
                                ))}
                        </div>
                    </Card>
                </div>
            );
        };

        // 2. CALENDARIO REAL (GRID)
        const CalendarModule = ({ data }) => {
            const [currentDate, setCurrentDate] = useState(new Date());

            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay(); // 0 is Sunday
            
            // Unificar todos los eventos
            const allEvents = useMemo(() => {
                return [
                    ...data.worship.map(e => ({...e, tag: 'Alabanza', color: 'bg-orange-100 text-orange-700'})),
                    ...data.ebd.map(e => ({...e, tag: 'EBD', color: 'bg-emerald-100 text-emerald-700', theme: e.topic})),
                    ...data.youth.map(e => ({...e, tag: 'JÃ³venes', color: 'bg-purple-100 text-purple-700', theme: e.title}))
                ];
            }, [data]);

            const getEventsForDay = (day) => {
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return allEvents.filter(e => e.date === dateStr);
            };

            const changeMonth = (offset) => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));
            };

            return (
                <div className="space-y-6 fade-in h-full flex flex-col">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">Calendario General</h2>
                        <div className="flex gap-2">
                            <Button variant="secondary" onClick={() => changeMonth(-1)}>&lt;</Button>
                            <span className="font-bold text-lg min-w-[150px] text-center capitalize">
                                {currentDate.toLocaleDateString('es-AR', { month: 'long', year: 'numeric' })}
                            </span>
                            <Button variant="secondary" onClick={() => changeMonth(1)}>&gt;</Button>
                        </div>
                    </div>

                    <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                        <div className="grid grid-cols-7 bg-slate-50 border-b border-slate-200">
                            {['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'].map(d => (
                                <div key={d} className="p-3 text-center text-xs font-bold uppercase text-slate-500">{d}</div>
                            ))}
                        </div>
                        <div className="grid grid-cols-7 flex-1 auto-rows-fr">
                            {Array.from({ length: firstDayOfMonth }).map((_, i) => <div key={`empty-${i}`} className="border-b border-r border-slate-100 bg-slate-50/50"></div>)}
                            {Array.from({ length: daysInMonth }).map((_, i) => {
                                const day = i + 1;
                                const events = getEventsForDay(day);
                                return (
                                    <div key={day} className="min-h-[100px] border-b border-r border-slate-100 p-2 hover:bg-slate-50 transition-colors">
                                        <div className="text-right mb-1"><span className="text-xs font-bold text-slate-400 bg-slate-100 rounded-full w-6 h-6 inline-flex items-center justify-center">{day}</span></div>
                                        <div className="space-y-1">
                                            {events.map((ev, idx) => (
                                                <div key={idx} className={`text-[10px] px-1.5 py-0.5 rounded truncate font-medium ${ev.color}`}>
                                                    {ev.tag === 'Alabanza' && ev.type === 'Ensayo' ? 'ðŸŽµ Ensayo' : ev.theme}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. DIRECTORIO & GESTIÃ“N DE MIEMBROS
        const Directory = ({ data, setData, user }) => {
            const [selectedMember, setSelectedMember] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [isAdding, setIsAdding] = useState(false);
            const [newMember, setNewMember] = useState({});
            const [newVisit, setNewVisit] = useState({ date: new Date().toISOString().split('T')[0], rating: 'Buena', note: '' });

            // Filtrado de miembros segÃºn rol
            const filteredMembers = useMemo(() => {
                let list = data.members;
                if (user.role === 'LÃ­der JÃ³venes') {
                    // LÃ­der de jÃ³venes solo ve jÃ³venes
                    list = list.filter(m => m.ministry === 'JÃ³venes' || m.ministry === 'Adolescentes');
                }
                return list.filter(m => 
                    m.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    m.ministry.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [data.members, searchTerm, user]);

            const handleAddMember = () => {
                const member = { ...newMember, id: Date.now(), visitHistory: [], photo: `https://ui-avatars.com/api/?name=${newMember.name}&background=random` };
                setData(prev => ({ ...prev, members: [...prev.members, member] }));
                setIsAdding(false);
            };

            const handleAddVisit = () => {
                if(!selectedMember) return;
                const updatedMembers = data.members.map(m => {
                    if(m.id === selectedMember.id) {
                        return { ...m, visitHistory: [newVisit, ...m.visitHistory] };
                    }
                    return m;
                });
                setData(prev => ({ ...prev, members: updatedMembers }));
                setSelectedMember(prev => ({ ...prev, visitHistory: [newVisit, ...prev.visitHistory] })); // Update local state for modal
                setNewVisit({ date: new Date().toISOString().split('T')[0], rating: 'Buena', note: '' });
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="relative w-full md:w-96">
                            <span className="absolute left-3 top-3 text-slate-400"><Icon name="Search" size={18}/></span>
                            <input 
                                type="text" 
                                placeholder={user.role === 'LÃ­der JÃ³venes' ? "Buscar joven..." : "Buscar miembro..."}
                                className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-brand-500"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <Button icon="Plus" onClick={() => setIsAdding(true)}>Nuevo Miembro</Button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {filteredMembers.map(m => (
                            <div key={m.id} className="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer relative" onClick={() => setSelectedMember(m)}>
                                <div className="absolute top-4 right-4">
                                    <Badge type={m.status === 'Activo' ? 'success' : 'danger'}>{m.status}</Badge>
                                </div>
                                <div className="flex flex-col items-center text-center mt-2">
                                    <img src={m.photo} alt={m.name} className="w-20 h-20 rounded-full object-cover mb-3 ring-4 ring-slate-50"/>
                                    <h3 className="font-bold text-slate-800 text-lg">{m.name}</h3>
                                    <p className="text-sm text-brand-600 font-semibold">{m.role} â€¢ {m.ministry}</p>
                                    
                                    <div className="mt-4 w-full bg-slate-50 p-3 rounded-xl border border-slate-100">
                                        <div className="flex justify-between text-xs font-bold text-slate-500 mb-1">
                                            <span>Visitas Realizadas</span>
                                            <span>{m.visitHistory.length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Ficha TÃ©cnica Detallada */}
                    <Modal isOpen={!!selectedMember} onClose={() => setSelectedMember(null)} title="Ficha TÃ©cnica">
                        {selectedMember && (
                            <div className="space-y-6">
                                <div className="flex gap-6 items-start">
                                    <img src={selectedMember.photo} className="w-24 h-24 rounded-2xl bg-slate-100 object-cover" />
                                    <div className="flex-1">
                                        <div className="flex justify-between">
                                            <h2 className="text-2xl font-bold text-slate-800">{selectedMember.name}</h2>
                                            <Badge type="brand">{selectedMember.role}</Badge>
                                        </div>
                                        <p className="text-slate-500 mb-2">{selectedMember.ministry}</p>
                                        <div className="grid grid-cols-2 gap-2 text-sm">
                                            <div className="bg-slate-50 p-2 rounded">ðŸŽ‚ {new Date().getFullYear() - new Date(selectedMember.birth).getFullYear()} aÃ±os</div>
                                            <div className="bg-slate-50 p-2 rounded">ðŸ“ž {selectedMember.phone}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* SecciÃ³n Visitas Mejorada */}
                                <div className="border-t border-slate-100 pt-4">
                                    <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="UserCheck"/> Registro de Visitas</h4>
                                    
                                    {/* Formulario Nueva Visita */}
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4">
                                        <p className="text-xs font-bold uppercase text-slate-500 mb-2">Registrar Nueva Visita</p>
                                        <div className="grid grid-cols-3 gap-2 mb-2">
                                            <input type="date" className="border rounded px-2 py-1 text-sm col-span-2" value={newVisit.date} onChange={e => setNewVisit({...newVisit, date: e.target.value})} />
                                            <select className="border rounded px-2 py-1 text-sm" value={newVisit.rating} onChange={e => setNewVisit({...newVisit, rating: e.target.value})}>
                                                <option>Buena</option><option>Regular</option><option>Urgente</option>
                                            </select>
                                        </div>
                                        <textarea className="w-full border rounded p-2 text-sm h-20 mb-2" placeholder="Detalles de la visita..." value={newVisit.note} onChange={e => setNewVisit({...newVisit, note: e.target.value})}></textarea>
                                        <Button onClick={handleAddVisit} className="w-full text-sm py-1">Guardar Visita</Button>
                                    </div>

                                    <div className="space-y-3 max-h-48 overflow-y-auto hide-scroll">
                                        {selectedMember.visitHistory.length > 0 ? selectedMember.visitHistory.map((v, i) => (
                                            <div key={i} className="bg-white border border-slate-100 p-3 rounded-lg shadow-sm">
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className="text-xs font-bold text-slate-500">{formatDate(v.date)}</span>
                                                    <Badge type={v.rating === 'Urgente' ? 'danger' : (v.rating === 'Regular' ? 'warning' : 'success')}>{v.rating}</Badge>
                                                </div>
                                                <p className="text-sm text-slate-700">{v.note}</p>
                                            </div>
                                        )) : <p className="text-sm text-slate-400 italic text-center">Sin visitas registradas.</p>}
                                    </div>
                                </div>
                                {user.role === 'Pastor' && (
                                    <div className="flex justify-end pt-4">
                                        <Button variant="danger" icon="Trash">Eliminar Miembro</Button>
                                    </div>
                                )}
                            </div>
                        )}
                    </Modal>

                    <Modal isOpen={isAdding} onClose={() => setIsAdding(false)} title="Nuevo Miembro">
                        <div className="grid grid-cols-1 gap-4">
                            <input className="w-full p-3 border rounded-lg" placeholder="Nombre Completo" onChange={e => setNewMember({...newMember, name: e.target.value})} />
                            <div className="grid grid-cols-2 gap-4">
                                <input className="p-3 border rounded-lg" type="date" onChange={e => setNewMember({...newMember, birth: e.target.value})} />
                                <input className="p-3 border rounded-lg" placeholder="TelÃ©fono" onChange={e => setNewMember({...newMember, phone: e.target.value})} />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <select className="p-3 border rounded-lg bg-white" onChange={e => setNewMember({...newMember, role: e.target.value})}>
                                    <option>Miembro</option><option>LÃ­der</option><option>Pastor</option><option>Servidor</option>
                                </select>
                                <select className="p-3 border rounded-lg bg-white" onChange={e => setNewMember({...newMember, ministry: e.target.value})}>
                                    <option>General</option><option>Alabanza</option><option>EBD</option><option>JÃ³venes</option>
                                </select>
                            </div>
                            <Button onClick={handleAddMember} className="w-full">Guardar Ficha</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        // 4. MINISTERIO DE ALABANZA
        const Worship = ({ data, setData }) => {
            const [isPlanning, setIsPlanning] = useState(false);
            const [newService, setNewService] = useState({ date: '', type: 'Culto', theme: '', songs: [], team: { Vocal: [], Guitarra: [], Bateria: [], Bajo: [] } });
            
            const musicians = data.members.filter(m => m.ministry === 'Alabanza' || m.role === 'Pastor');
            
            const handleAddSong = () => {
                const song = prompt("Nombre de la canciÃ³n:");
                if(song) setNewService(prev => ({...prev, songs: [...prev.songs, song]}));
            };

            const toggleMusician = (role, name) => {
                setNewService(prev => {
                    const current = prev.team[role];
                    const updated = current.includes(name) ? current.filter(n => n !== name) : [...current, name];
                    return { ...prev, team: { ...prev.team, [role]: updated } };
                });
            };

            const saveService = () => {
                setData(prev => ({ ...prev, worship: [...prev.worship, { ...newService, id: Date.now() }] }));
                setIsPlanning(false);
            };

            const deleteService = (id) => {
                if(confirm('Â¿Eliminar esta planificaciÃ³n?')) {
                    setData(prev => ({...prev, worship: prev.worship.filter(w => w.id !== id)}));
                }
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">Ministerio de Alabanza</h2>
                        <Button icon="Plus" onClick={() => setIsPlanning(true)}>Planificar</Button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {data.worship.sort((a,b)=> new Date(b.date)-new Date(a.date)).map(s => (
                            <Card key={s.id} className="relative overflow-hidden group">
                                <div className={`absolute top-0 left-0 w-2 h-full ${s.type === 'Ensayo' ? 'bg-slate-400' : 'bg-brand-500'}`}></div>
                                <div className="flex justify-between mb-4 pl-2">
                                    <div>
                                        <Badge type={s.type === 'Ensayo' ? 'default' : 'brand'}>{s.type}</Badge>
                                        <h3 className="font-bold text-xl mt-1">{s.theme}</h3>
                                    </div>
                                    <div className="text-right">
                                        <span className="block text-xs font-bold text-slate-400">{formatDate(s.date)}</span>
                                        <button onClick={() => deleteService(s.id)} className="text-red-400 hover:text-red-600 mt-2 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="Trash" size={16}/></button>
                                    </div>
                                </div>
                                <div className="space-y-4 pl-2">
                                    <div className="bg-slate-50 p-3 rounded-lg">
                                        <p className="text-xs font-bold text-slate-400 uppercase mb-2">Setlist</p>
                                        <div className="flex flex-wrap gap-1">
                                            {s.songs.map((song, i) => <span key={i} className="text-xs bg-white border px-1.5 py-0.5 rounded">{song}</span>)}
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>

                    <Modal isOpen={isPlanning} onClose={() => setIsPlanning(false)} title="Planificador">
                        <div className="space-y-4">
                            <div className="grid grid-cols-3 gap-4">
                                <div className="col-span-1">
                                    <label className="text-xs font-bold uppercase text-slate-500">Tipo</label>
                                    <select className="w-full border p-2 rounded" value={newService.type} onChange={e => setNewService({...newService, type: e.target.value})}>
                                        <option>Culto</option><option>Ensayo</option>
                                    </select>
                                </div>
                                <div className="col-span-2"><label className="text-xs font-bold uppercase text-slate-500">Fecha</label><input type="date" className="w-full border p-2 rounded" onChange={e => setNewService({...newService, date: e.target.value})}/></div>
                            </div>
                            <div><label className="text-xs font-bold uppercase text-slate-500">Tema / Objetivo</label><input type="text" className="w-full border p-2 rounded" placeholder="Ej: Domingo de Gracia" onChange={e => setNewService({...newService, theme: e.target.value})}/></div>
                            
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-xs font-bold uppercase text-slate-500">Canciones</label>
                                    <button onClick={handleAddSong} className="text-xs text-brand-600 font-bold">+ Agregar</button>
                                </div>
                                <div className="flex flex-wrap gap-2 p-3 bg-slate-50 rounded-lg min-h-[3rem]">
                                    {newService.songs.map((s,i) => <Badge key={i} type="brand">{s}</Badge>)}
                                </div>
                            </div>
                            <div className="border-t pt-2">
                                <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">Armado de Banda</label>
                                {['Vocal', 'Guitarra', 'Bateria', 'Bajo'].map(inst => (
                                    <div key={inst} className="mb-3">
                                        <p className="text-xs font-bold text-slate-700 mb-1">{inst}</p>
                                        <div className="flex flex-wrap gap-1">
                                            {musicians.map(m => (
                                                <button key={m.id} 
                                                    onClick={() => toggleMusician(inst, m.name)}
                                                    className={`text-xs px-2 py-1 rounded border transition-colors ${newService.team[inst].includes(m.name) ? 'bg-brand-600 text-white border-brand-600' : 'bg-white text-slate-600 hover:bg-slate-50'}`}>
                                                    {m.name}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <Button onClick={saveService} className="w-full">Guardar PlanificaciÃ³n</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        // 5. TESORERÃA (Solo Pastor)
        const Finances = ({ data, setData }) => {
            const [isClosing, setIsClosing] = useState(false);
            const [moveType, setMoveType] = useState('Culto'); // Culto, Ingreso, Gasto
            const [movement, setMovement] = useState({ date: '', cash: 0, transfer: 0, tithesCount: 0, notes: '' });

            const handleSave = () => {
                // Si es gasto, los valores son negativos
                let finalCash = movement.cash;
                let finalTransfer = movement.transfer;
                if(moveType === 'Gasto') {
                    finalCash = -Math.abs(finalCash);
                    finalTransfer = -Math.abs(finalTransfer);
                }

                setData(prev => ({ ...prev, finances: [{ ...movement, cash: finalCash, transfer: finalTransfer, id: Date.now(), type: moveType }, ...prev.finances] }));
                setIsClosing(false);
            };

            const totalCash = data.finances.reduce((acc, f) => acc + f.cash, 0);
            const totalTransfer = data.finances.reduce((acc, f) => acc + f.transfer, 0);

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">TesorerÃ­a EclesiÃ¡stica</h2>
                        <div className="flex gap-2">
                            <Button variant="danger" icon="Plus" onClick={() => { setMoveType('Gasto'); setIsClosing(true); }}>Gasto</Button>
                            <Button variant="secondary" icon="Plus" onClick={() => { setMoveType('Ingreso'); setIsClosing(true); }}>Ingreso</Button>
                            <Button icon="Plus" onClick={() => { setMoveType('Culto'); setIsClosing(true); }}>Cierre Culto</Button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Chip Inteligente Efectivo */}
                        <div className="bg-white p-5 rounded-2xl border-l-4 border-emerald-500 shadow-sm flex items-center justify-between">
                            <div>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Caja Chica (Efectivo)</p>
                                <p className="text-2xl font-bold text-slate-800">{formatCurrency(totalCash)}</p>
                            </div>
                            <div className="bg-emerald-50 p-3 rounded-full text-emerald-600"><Icon name="Wallet"/></div>
                        </div>
                        {/* Chip Inteligente Banco */}
                        <div className="bg-white p-5 rounded-2xl border-l-4 border-blue-500 shadow-sm flex items-center justify-between">
                            <div>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Banco / MercadoPago</p>
                                <p className="text-2xl font-bold text-slate-800">{formatCurrency(totalTransfer)}</p>
                            </div>
                            <div className="bg-blue-50 p-3 rounded-full text-blue-600"><Icon name="Bank"/></div>
                        </div>
                    </div>

                    <Card>
                        <h3 className="font-bold text-slate-800 mb-4">Movimientos Recientes</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                                    <tr>
                                        <th className="p-3 rounded-l-lg">Fecha</th>
                                        <th className="p-3">Detalle</th>
                                        <th className="p-3 text-right">Efectivo</th>
                                        <th className="p-3 text-right">Banco</th>
                                        <th className="p-3 text-center rounded-r-lg">Tipo</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {data.finances.map(f => (
                                        <tr key={f.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-3 font-medium">{formatDate(f.date)}</td>
                                            <td className="p-3 text-slate-600">{f.notes}</td>
                                            <td className={`p-3 text-right font-mono ${f.cash < 0 ? 'text-red-500' : 'text-slate-700'}`}>{formatCurrency(f.cash)}</td>
                                            <td className={`p-3 text-right font-mono ${f.transfer < 0 ? 'text-red-500' : 'text-slate-700'}`}>{formatCurrency(f.transfer)}</td>
                                            <td className="p-3 text-center">
                                                <Badge type={f.type === 'Gasto' ? 'danger' : (f.type === 'Ingreso' ? 'success' : 'brand')}>{f.type}</Badge>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    <Modal isOpen={isClosing} onClose={() => setIsClosing(false)} title={`Registrar ${moveType}`}>
                        <div className="space-y-4">
                            <input type="date" className="w-full border p-3 rounded-lg" onChange={e => setMovement({...movement, date: e.target.value})}/>
                            <input type="text" placeholder="Concepto / Detalle" className="w-full border p-3 rounded-lg" onChange={e => setMovement({...movement, notes: e.target.value})}/>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold uppercase">Monto Efectivo</label><input type="number" className="w-full border p-3 rounded-lg" onChange={e => setMovement({...movement, cash: parseInt(e.target.value)})}/></div>
                                <div><label className="text-xs font-bold uppercase">Monto Transferencia</label><input type="number" className="w-full border p-3 rounded-lg" onChange={e => setMovement({...movement, transfer: parseInt(e.target.value)})}/></div>
                            </div>
                            {moveType === 'Culto' && (
                                <div><label className="text-xs font-bold uppercase">Cantidad de Diezmantes</label><input type="number" className="w-full border p-3 rounded-lg" onChange={e => setMovement({...movement, tithesCount: parseInt(e.target.value)})}/></div>
                            )}
                            <Button onClick={handleSave} className="w-full">Registrar</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        // 6. MINISTERIO DE JÃ“VENES (Con Colaboradores)
        const YouthModule = ({ data, setData }) => {
            const [activeTab, setActiveTab] = useState('events');
            const [isOpen, setIsOpen] = useState(false);
            const [newItem, setNewItem] = useState({});

            const handleSave = () => {
                if(activeTab === 'events') {
                    setData(prev => ({...prev, youth: [...prev.youth, {...newItem, id: Date.now()}]}));
                } else {
                    setData(prev => ({...prev, youthTasks: [...prev.youthTasks, {...newItem, id: Date.now(), status: 'Pendiente'}]}));
                }
                setIsOpen(false);
            };

            const toggleTask = (id) => {
                const tasks = data.youthTasks.map(t => t.id === id ? {...t, status: t.status === 'Completado' ? 'Pendiente' : 'Completado'} : t);
                setData(prev => ({...prev, youthTasks: tasks}));
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">Ministerio de JÃ³venes</h2>
                        <Button icon="Plus" onClick={() => setIsOpen(true)}>{activeTab === 'events' ? 'Nuevo Evento' : 'Nueva Tarea'}</Button>
                    </div>

                    <div className="flex gap-4 border-b border-slate-200">
                        <button onClick={() => setActiveTab('events')} className={`pb-2 px-4 font-bold ${activeTab === 'events' ? 'text-brand-600 border-b-2 border-brand-600' : 'text-slate-400'}`}>Eventos</button>
                        <button onClick={() => setActiveTab('collab')} className={`pb-2 px-4 font-bold ${activeTab === 'collab' ? 'text-brand-600 border-b-2 border-brand-600' : 'text-slate-400'}`}>Colaboradores & Tareas</button>
                    </div>

                    {activeTab === 'events' ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {data.youth.map(i => (
                                <Card key={i.id} className="flex gap-4">
                                    <div className="bg-purple-100 p-3 rounded-xl flex flex-col items-center justify-center min-w-[4rem] text-purple-700">
                                        <span className="font-bold text-xl">{new Date(i.date+'T00:00:00').getDate()}</span>
                                        <span className="text-xs uppercase">{new Date(i.date+'T00:00:00').toLocaleDateString('es-AR',{month:'short'})}</span>
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-lg text-slate-800">{i.title}</h3>
                                        <p className="text-sm text-slate-500">{i.location}</p>
                                    </div>
                                </Card>
                            ))}
                        </div>
                    ) : (
                        <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                             {data.youthTasks.map(t => (
                                <div key={t.id} className="p-4 border-b border-slate-100 flex items-center justify-between hover:bg-slate-50">
                                    <div className="flex items-center gap-3">
                                        <button onClick={() => toggleTask(t.id)} className={`w-5 h-5 rounded border flex items-center justify-center ${t.status === 'Completado' ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300'}`}>
                                            {t.status === 'Completado' && <Icon name="UserCheck" size={14}/>}
                                        </button>
                                        <span className={t.status === 'Completado' ? 'line-through text-slate-400' : 'text-slate-700 font-medium'}>{t.task}</span>
                                    </div>
                                    <Badge type="blue">{t.assignee}</Badge>
                                </div>
                             ))}
                        </div>
                    )}
                    
                    <Modal isOpen={isOpen} onClose={() => setIsOpen(false)} title={`Nuevo ${activeTab === 'events' ? 'Evento' : 'Tarea'}`}>
                        <div className="space-y-4">
                            {activeTab === 'events' ? (
                                <>
                                    <input type="date" className="w-full border p-3 rounded-lg" onChange={e => setNewItem({...newItem, date: e.target.value})}/>
                                    <input type="text" placeholder="TÃ­tulo del Evento" className="w-full border p-3 rounded-lg" onChange={e => setNewItem({...newItem, title: e.target.value})}/>
                                    <input type="text" placeholder="Lugar" className="w-full border p-3 rounded-lg" onChange={e => setNewItem({...newItem, location: e.target.value})}/>
                                </>
                            ) : (
                                <>
                                    <input type="text" placeholder="DescripciÃ³n de la Tarea" className="w-full border p-3 rounded-lg" onChange={e => setNewItem({...newItem, task: e.target.value})}/>
                                    <label className="text-xs font-bold uppercase text-slate-500">Asignar a:</label>
                                    <select className="w-full border p-3 rounded-lg" onChange={e => setNewItem({...newItem, assignee: e.target.value})}>
                                        <option value="">Seleccionar Colaborador</option>
                                        {data.members.filter(m => m.ministry === 'JÃ³venes' || m.role === 'Servidor').map(m => (
                                            <option key={m.id} value={m.name}>{m.name}</option>
                                        ))}
                                    </select>
                                </>
                            )}
                            <Button onClick={handleSave} className="w-full">Guardar</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        // 7. GENÃ‰RICO (EBD)
        const GenericModule = ({ title, items, onAdd }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [newItem, setNewItem] = useState({});

            const handleSave = () => {
                onAdd({ ...newItem, id: Date.now() });
                setIsOpen(false);
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">{title}</h2>
                        <Button icon="Plus" onClick={() => setIsOpen(true)}>Nueva Clase</Button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {items.map(i => (
                            <Card key={i.id} className="flex gap-4">
                                <div className="bg-emerald-100 p-3 rounded-xl flex flex-col items-center justify-center min-w-[4rem] text-emerald-700">
                                    <span className="font-bold text-xl">{new Date(i.date+'T00:00:00').getDate()}</span>
                                    <span className="text-xs uppercase">{new Date(i.date+'T00:00:00').toLocaleDateString('es-AR',{month:'short'})}</span>
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800">{i.topic}</h3>
                                    <p className="text-sm text-slate-500">Maestros: {i.teachers.join(', ')}</p>
                                    <Badge>Alumnos: {i.students}</Badge>
                                </div>
                            </Card>
                        ))}
                    </div>
                    <Modal isOpen={isOpen} onClose={() => setIsOpen(false)} title="Nueva Clase">
                        <div className="space-y-4">
                            <input type="date" className="w-full border p-3 rounded-lg" onChange={e => setNewItem({...newItem, date: e.target.value})}/>
                            <input type="text" placeholder="Tema de la Clase" className="w-full border p-3 rounded-lg" onChange={e => setNewItem({...newItem, topic: e.target.value})}/>
                            <input type="text" placeholder="Maestros (separar con comas)" className="w-full border p-3 rounded-lg" onChange={e => setNewItem({...newItem, teachers: e.target.value.split(',')})}/>
                            <Button onClick={handleSave} className="w-full">Guardar</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        // --- APP SHELL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [data, setData] = useState(INITIAL_DATA);
            const [sidebarOpen, setSidebarOpen] = useState(false);

            const addEBD = (item) => setData(prev => ({...prev, ebd: [...prev.ebd, item]}));
            
            // LOGIN
            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                        <div className="max-w-md w-full bg-white p-8 rounded-3xl shadow-xl">
                            <div className="text-center mb-8">
                                <div className="bg-brand-600 w-16 h-16 rounded-2xl mx-auto flex items-center justify-center text-white mb-4 shadow-lg shadow-brand-500/40">
                                    <Icon name="Home" size={32}/>
                                </div>
                                <h1 className="text-2xl font-bold text-slate-800">Conquistadores v3.0</h1>
                                <p className="text-slate-500">Selecciona tu Rol</p>
                            </div>
                            <div className="space-y-3">
                                {[
                                    { name: 'Pastor Roberto', role: 'Pastor', icon: 'Home', color: 'bg-brand-50 text-brand-700' },
                                    { name: 'Lucas Diaz', role: 'LÃ­der Alabanza', ministry: 'Alabanza', icon: 'Music', color: 'bg-blue-50 text-blue-700' },
                                    { name: 'Javier K.', role: 'LÃ­der JÃ³venes', ministry: 'JÃ³venes', icon: 'Smile', color: 'bg-purple-50 text-purple-700' },
                                    { name: 'Pedro Server', role: 'Servidor General', ministry: 'General', icon: 'UserCheck', color: 'bg-slate-100 text-slate-700' }
                                ].map((u, i) => (
                                    <button key={i} onClick={() => setUser({ name: u.name, role: u.role, ministry: u.ministry })} 
                                        className="w-full p-4 border border-slate-200 rounded-xl hover:bg-slate-50 flex items-center gap-4 transition-all hover:scale-[1.02]">
                                        <div className={`p-3 rounded-lg ${u.color}`}><Icon name={u.icon} /></div>
                                        <div className="text-left">
                                            <p className="font-bold text-slate-800">{u.role}</p>
                                            <p className="text-xs text-slate-500">{u.name}</p>
                                        </div>
                                        <Icon name="ChevronRight" className="ml-auto text-slate-300"/>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            const NavItem = ({ id, icon, label }) => (
                <button 
                    onClick={() => { setActiveTab(id); setSidebarOpen(false); }} 
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all mb-1 ${activeTab === id ? 'bg-brand-600 text-white shadow-lg shadow-brand-900/20' : 'text-brand-100/70 hover:bg-brand-800 hover:text-white'}`}>
                    <Icon name={icon} /> {label}
                </button>
            );

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden">
                    {/* Sidebar */}
                    <aside className={`fixed md:relative z-40 w-72 bg-brand-900 text-white h-full flex flex-col transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="p-6">
                            <div className="flex items-center gap-3 mb-8">
                                <div className="bg-white/10 p-2 rounded-lg"><Icon name="Home" /></div>
                                <span className="font-bold text-lg tracking-tight">Conquistadores</span>
                            </div>
                            <nav>
                                <NavItem id="dashboard" icon="Home" label="Inicio" />
                                <NavItem id="calendar" icon="Calendar" label="Calendario" />
                                <NavItem id="directory" icon="Users" label={user.role === 'LÃ­der JÃ³venes' ? "Mis JÃ³venes" : "Directorio"} />
                                
                                <div className="my-4 px-4 text-xs font-bold text-brand-500/60 uppercase tracking-widest">Ministerios</div>
                                {(user.role === 'Pastor' || user.ministry === 'Alabanza') && <NavItem id="worship" icon="Music" label="Alabanza" />}
                                {(user.role === 'Pastor' || user.ministry === 'EBD') && <NavItem id="ebd" icon="Book" label="Escuela BÃ­blica" />}
                                {(user.role === 'Pastor' || user.ministry === 'JÃ³venes') && <NavItem id="youth" icon="Smile" label="JÃ³venes" />}
                                
                                {user.role === 'Pastor' && (
                                    <>
                                        <div className="my-4 px-4 text-xs font-bold text-brand-500/60 uppercase tracking-widest">Admin</div>
                                        <NavItem id="finances" icon="Wallet" label="TesorerÃ­a" />
                                        <NavItem id="messages" icon="Mail" label="MensajerÃ­a" />
                                    </>
                                )}
                            </nav>
                        </div>
                        <div className="mt-auto p-6 bg-brand-950">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-brand-700 flex items-center justify-center font-bold">{user.name[0]}</div>
                                <div className="flex-1 overflow-hidden">
                                    <p className="font-bold text-sm truncate">{user.name}</p>
                                    <p className="text-xs text-brand-400">{user.role}</p>
                                </div>
                                <button onClick={() => setUser(null)} className="text-brand-400 hover:text-white"><Icon name="LogOut" /></button>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto relative w-full bg-slate-50">
                        <header className="md:hidden bg-white p-4 sticky top-0 z-30 shadow-sm flex justify-between items-center">
                            <span className="font-bold text-brand-900">Conquistadores</span>
                            <button onClick={() => setSidebarOpen(true)} className="text-slate-600"><Icon name="Menu" /></button>
                        </header>

                        <div className="p-4 md:p-8 max-w-7xl mx-auto pb-24 h-full">
                            {activeTab === 'dashboard' && <Dashboard user={user} data={data} />}
                            {activeTab === 'calendar' && <CalendarModule data={data} />}
                            {activeTab === 'directory' && <Directory data={data} setData={setData} user={user} />}
                            {activeTab === 'worship' && <Worship data={data} setData={setData} />}
                            {activeTab === 'finances' && <Finances data={data} setData={setData} />}
                            {activeTab === 'ebd' && <GenericModule title="Escuela BÃ­blica" items={data.ebd} onAdd={addEBD} />}
                            {activeTab === 'youth' && <YouthModule data={data} setData={setData} />}
                            
                            {activeTab === 'messages' && (
                                <div className="fade-in">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-6">MensajerÃ­a Masiva</h2>
                                    <Card>
                                        <textarea placeholder="Escribe tu mensaje aquÃ­..." className="w-full border p-4 rounded-xl h-32 mb-4 bg-slate-50 focus:bg-white transition-colors"></textarea>
                                        <div className="flex justify-between items-center">
                                            <select className="border p-2 rounded-lg bg-white"><option>Todos</option><option>LÃ­deres</option><option>Alabanza</option></select>
                                            <Button icon="Mail">Enviar Mensaje</Button>
                                        </div>
                                    </Card>
                                </div>
                            )}
                        </div>
                    </main>
                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setSidebarOpen(false)}></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
