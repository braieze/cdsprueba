<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conquistadores App - Gesti贸n Real</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Recharts (Gr谩ficos) -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    
    <!-- FIREBASE SDKs (Compatibles con CDN) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Configuraci贸n de Fuentes y Colores -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50:'#fff7ed', 100:'#ffedd5', 500:'#f97316', 600:'#ea580c', 700:'#c2410c', 900:'#7c2d12' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- INICIALIZACIN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDXK_EcXsFGhRmXfkKG8SMdsM69c4PNfHw",
            authDomain: "conquistadoresapp.firebaseapp.com",
            projectId: "conquistadoresapp",
            storageBucket: "conquistadoresapp.firebasestorage.app",
            messagingSenderId: "518647225464",
            appId: "1:518647225464:web:b3344ca5172498187e218d"
        };

        // Inicializar solo si no existe ya
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // --- REACT & UTILS ---
        const { useState, useEffect, useMemo } = React;
        const RechartsObj = window.Recharts || {};
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = RechartsObj;

        // --- ICONOS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Home: <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>,
                Users: <React.Fragment><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></React.Fragment>,
                Wallet: <React.Fragment><path d="M20 12V8H6a2 2 0 0 1 0-4h14v4"/><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"/><path d="M18 12a2 2 0 0 0 0 4h4v-4z"/></React.Fragment>,
                Music: <React.Fragment><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></React.Fragment>,
                Book: <React.Fragment><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></React.Fragment>,
                Smile: <React.Fragment><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></React.Fragment>,
                Bell: <React.Fragment><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></React.Fragment>,
                Calendar: <React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></React.Fragment>,
                LogOut: <React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></React.Fragment>,
                Plus: <React.Fragment><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></React.Fragment>,
                X: <React.Fragment><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></React.Fragment>,
                Menu: <React.Fragment><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></React.Fragment>,
                Search: <React.Fragment><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></React.Fragment>,
                Trash: <React.Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></React.Fragment>,
                Edit: <React.Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></React.Fragment>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                Bank: <React.Fragment><path d="M3 21h18"/><path d="M5 21v-7"/><path d="M19 21v-7"/><path d="M10 21v-4a2 2 0 0 1 4 0v4"/><polyline points="2 7 12 2 22 7"/><path d="M3 7v5a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V7"/></React.Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        const formatDate = (d) => {
            if(!d) return '';
            const date = new Date(d);
            // Ajuste simple para zona horaria si es fecha pura string (YYYY-MM-DD)
            if(d.length === 10) date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
            return date.toLocaleDateString('es-AR', { day: 'numeric', month: 'short' });
        };
        const formatCurrency = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(val);

        // --- COMPONENTES UI ---
        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 p-6 ${className}`}>{children}</div>;
        const Badge = ({ children, type = 'default' }) => {
            const styles = { default: "bg-slate-100 text-slate-600", success: "bg-emerald-100 text-emerald-700", warning: "bg-amber-100 text-amber-700", danger: "bg-red-100 text-red-700", brand: "bg-brand-100 text-brand-700", blue: "bg-blue-100 text-blue-700" };
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide ${styles[type] || styles.default}`}>{children}</span>;
        };
        const Button = ({ children, onClick, variant = 'primary', icon, className = "", disabled=false }) => {
            const styles = { primary: "bg-brand-600 text-white hover:bg-brand-700 shadow-lg shadow-brand-500/30", secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50", danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100" };
            return <button disabled={disabled} onClick={onClick} className={`flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl font-semibold transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed ${styles[variant]} ${className}`}>{icon && <Icon name={icon} size={18} />}{children}</button>;
        };
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                            <h3 className="text-xl font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><Icon name="X" /></button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        // --- PANTALLA DE LOGIN CON GOOGLE ---
        const LoginScreen = ({ onLogin, loading, error }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                <Card className="max-w-md w-full text-center space-y-8 py-12">
                    <div className="bg-brand-100 w-20 h-20 rounded-3xl mx-auto flex items-center justify-center text-brand-600 mb-6"><Icon name="Home" size={40}/></div>
                    <div>
                        <h1 className="text-3xl font-extrabold text-slate-800">Conquistadores App</h1>
                        <p className="text-slate-500 mt-2">Plataforma de Gesti贸n Integral</p>
                    </div>
                    {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">{error}</div>}
                    <Button onClick={onLogin} className="w-full justify-center py-4 text-lg" disabled={loading}>
                        {loading ? 'Conectando...' : 'Iniciar Sesi贸n con Google'}
                    </Button>
                    <p className="text-xs text-slate-400">Acceso exclusivo para miembros registrados</p>
                </Card>
            </div>
        );

        // --- COMPONENTE PRINCIPAL ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null); // Usuario de Firebase Auth
            const [userProfile, setUserProfile] = useState(null); // Perfil en Firestore (Rol, Ministerio)
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [authError, setAuthError] = useState(null);
            
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);

            // Datos de la App (Estados)
            const [members, setMembers] = useState([]);
            const [finances, setFinances] = useState([]);
            const [worship, setWorship] = useState([]);
            const [ebd, setEbd] = useState([]);
            const [youth, setYouth] = useState([]);
            const [youthTasks, setYouthTasks] = useState([]);
            const [messages, setMessages] = useState([]);

            // --- LISTENERS DE FIREBASE ---
            
            // 1. Auth Listener
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        setCurrentUser(user);
                        // Buscar perfil en Firestore por email
                        const q = db.collection('members').where('email', '==', user.email);
                        const snapshot = await q.get();
                        
                        if (!snapshot.empty) {
                            // Usuario existe, cargar perfil
                            const profileData = snapshot.docs[0].data();
                            setUserProfile({ ...profileData, id: snapshot.docs[0].id });
                        } else {
                            // Usuario NO existe en Directorio.
                            // VERIFICAR SI LA BASE DE DATOS EST VACA (Primer uso)
                            const checkEmpty = await db.collection('members').get();
                            if(checkEmpty.empty) {
                                // Caso Bootstrap: Primer usuario se convierte en Pastor
                                const newAdmin = {
                                    name: user.displayName || 'Pastor Principal',
                                    email: user.email,
                                    role: 'Pastor',
                                    ministry: 'Pastoral',
                                    photo: user.photoURL,
                                    status: 'Activo',
                                    visitHistory: [],
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                await db.collection('members').add(newAdmin);
                                setUserProfile(newAdmin);
                            } else {
                                // Caso normal: Usuario no registrado
                                setUserProfile(null); 
                                setAuthError("Tu email no est谩 registrado en el Directorio. Contacta al Pastor.");
                            }
                        }
                    } else {
                        setCurrentUser(null);
                        setUserProfile(null);
                    }
                    setLoadingAuth(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Data Listeners (Solo si hay usuario autenticado)
            useEffect(() => {
                if (!userProfile) return;

                const unsubs = [];
                // Helpers para escuchar colecciones
                const sub = (col, setter) => {
                    unsubs.push(db.collection(col).onSnapshot(snap => {
                        const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setter(data);
                    }));
                };

                sub('members', setMembers);
                sub('finances', setFinances);
                sub('worship', setWorship);
                sub('ebd', setEbd);
                sub('youth', setYouth);
                sub('youthTasks', setYouthTasks);
                sub('messages', setMessages);

                return () => unsubs.forEach(u => u());
            }, [userProfile]);

            // --- ACCIONES ---
            const handleLogin = async () => {
                try {
                    setAuthError(null);
                    await auth.signInWithPopup(googleProvider);
                } catch (err) {
                    console.error(err);
                    setAuthError("Error al iniciar sesi贸n con Google.");
                }
            };

            const handleLogout = () => auth.signOut();

            // Helpers CRUD Gen茅ricos
            const addData = (col, data) => db.collection(col).add(data);
            const updateData = (col, id, data) => db.collection(col).doc(id).update(data);
            const deleteData = (col, id) => {
                if(window.confirm("驴Est谩s seguro de eliminar esto?")) db.collection(col).doc(id).delete();
            };

            // Renderizado Condicional de Login
            if (loadingAuth) return <div className="min-h-screen flex items-center justify-center text-slate-500">Cargando sistema...</div>;
            if (!currentUser || (currentUser && !userProfile && authError)) return <LoginScreen onLogin={handleLogin} error={authError} />;
            if (!userProfile) return <LoginScreen onLogin={handleLogin} error="Esperando perfil..." />;

            // --- MDULOS DE UI ---

            // DASHBOARD
            const Dashboard = () => {
                const totalCash = finances.reduce((acc, f) => acc + (f.cash || 0), 0);
                const totalTransfer = finances.reduce((acc, f) => acc + (f.transfer || 0), 0);
                
                // Servicios asignados al usuario
                const myServices = [
                    ...worship.filter(w => Object.values(w.team || {}).flat().includes(userProfile.name)).map(w => ({ ...w, from: 'Alabanza', title: w.theme })),
                    ...ebd.filter(e => (e.teachers || []).includes(userProfile.name)).map(e => ({ ...e, from: 'EBD', title: e.topic })),
                    ...youthTasks.filter(t => t.assignee === userProfile.name && t.status === 'Pendiente').map(t => ({ ...t, from: 'J贸venes', title: t.task, isTask: true }))
                ].sort((a,b) => new Date(a.date || 0) - new Date(b.date || 0));

                return (
                    <div className="space-y-6 fade-in">
                        <div className="flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Hola, {userProfile.name.split(' ')[0]} </h2>
                                <p className="text-slate-500">Panel de {userProfile.role}</p>
                            </div>
                            {userProfile.role === 'Pastor' && (
                                <div className="bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm">
                                    <p className="text-xs text-slate-400 font-bold uppercase">Caja Total</p>
                                    <p className="text-xl font-bold text-emerald-600">{formatCurrency(totalCash + totalTransfer)}</p>
                                </div>
                            )}
                        </div>

                        <Card className="border-l-4 border-l-brand-500 bg-brand-50/30">
                            <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2"><Icon name="Bell" className="text-brand-600"/> Mis Pendientes & Servicios</h3>
                            {myServices.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {myServices.map((s, i) => (
                                        <div key={i} className="bg-white p-3 rounded-lg border border-brand-100 shadow-sm">
                                            <div className="flex justify-between mb-1">
                                                <Badge type="brand">{s.from}</Badge>
                                                <span className="text-xs font-bold text-slate-400">{s.isTask ? 'Tarea' : formatDate(s.date)}</span>
                                            </div>
                                            <p className="font-semibold text-slate-800 truncate">{s.title}</p>
                                        </div>
                                    ))}
                                </div>
                            ) : <p className="text-slate-500 italic text-sm">No tienes asignaciones pendientes.</p>}
                        </Card>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2">
                                <Card>
                                    <h3 className="font-bold mb-4">Mensajes del Equipo</h3>
                                    <div className="space-y-3">
                                        {messages.slice(0, 5).map(m => (
                                            <div key={m.id} className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                                                <div className="flex justify-between">
                                                    <span className="font-bold text-sm text-brand-700">{m.from}</span>
                                                    <span className="text-xs text-slate-400">{formatDate(m.date)}</span>
                                                </div>
                                                <p className="text-sm text-slate-600 mt-1">{m.content}</p>
                                            </div>
                                        ))}
                                        {messages.length === 0 && <p className="text-center text-slate-400 text-sm">No hay mensajes recientes.</p>}
                                    </div>
                                </Card>
                            </div>
                            <Card className="bg-slate-800 text-white">
                                <h3 className="font-bold mb-4 flex items-center gap-2"><Icon name="Calendar"/> Pr贸ximos Eventos</h3>
                                <div className="space-y-3">
                                    {[...worship, ...ebd, ...youth].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0,5).map((e,i) => (
                                        <div key={i} className="flex gap-3 border-b border-slate-700 pb-2 last:border-0">
                                            <div className="text-center min-w-[3rem]">
                                                <span className="block font-bold text-lg">{e.date ? new Date(e.date).getDate() : '-'}</span>
                                                <span className="text-[10px] uppercase text-slate-400">{e.date ? new Date(e.date).toLocaleDateString('es-AR',{month:'short'}) : ''}</span>
                                            </div>
                                            <div>
                                                <p className="font-medium text-sm truncate">{e.theme || e.topic || e.title}</p>
                                                <Badge type="default">{e.topic ? 'EBD' : (e.theme ? 'Culto' : 'J贸venes')}</Badge>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        </div>
                    </div>
                );
            };

            // DIRECTORIO
            const Directory = () => {
                const [selected, setSelected] = useState(null);
                const [isAdding, setIsAdding] = useState(false);
                const [newMember, setNewMember] = useState({ name: '', role: 'Miembro', ministry: 'General', email: '' });
                const [searchTerm, setSearchTerm] = useState('');

                // L贸gica de email obligatorio
                const isEmailRequired = ['Pastor', 'L铆der', 'Servidor General'].includes(newMember.role);

                const handleSaveMember = () => {
                    if (isEmailRequired && !newMember.email) return alert("Para este rol, el email es obligatorio (acceso al sistema).");
                    
                    addData('members', {
                        ...newMember,
                        photo: `https://ui-avatars.com/api/?name=${newMember.name}&background=random`,
                        status: 'Activo',
                        visitHistory: []
                    });
                    setIsAdding(false);
                    setNewMember({ name: '', role: 'Miembro', ministry: 'General', email: '' });
                };

                const updateRole = (memberId, field, value) => updateData('members', memberId, { [field]: value });

                // Filtro para L铆der de J贸venes
                const filteredMembers = members.filter(m => {
                    const matchSearch = m.name.toLowerCase().includes(searchTerm.toLowerCase());
                    if (userProfile.role === 'L铆der J贸venes') return matchSearch && (m.ministry === 'J贸venes' || m.ministry === 'Adolescentes');
                    return matchSearch;
                });

                return (
                    <div className="space-y-6 fade-in">
                        <div className="flex justify-between items-center gap-4">
                            <input className="border p-2 rounded-lg w-full max-w-sm" placeholder="Buscar..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                            <Button icon="Plus" onClick={() => setIsAdding(true)}>Nuevo</Button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {filteredMembers.map(m => (
                                <div key={m.id} onClick={() => setSelected(m)} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer transition-all flex flex-col items-center text-center">
                                    <img src={m.photo} className="w-16 h-16 rounded-full mb-3 bg-slate-100"/>
                                    <h3 className="font-bold text-slate-800">{m.name}</h3>
                                    <p className="text-xs text-brand-600 font-bold uppercase">{m.role}</p>
                                    <p className="text-xs text-slate-400">{m.ministry}</p>
                                </div>
                            ))}
                        </div>

                        <Modal isOpen={!!selected} onClose={() => setSelected(null)} title="Ficha T茅cnica">
                            {selected && (
                                <div className="space-y-6">
                                    <div className="flex items-center gap-4">
                                        <img src={selected.photo} className="w-20 h-20 rounded-full"/>
                                        <div>
                                            <h2 className="text-xl font-bold">{selected.name}</h2>
                                            <p className="text-sm text-slate-500">{selected.email || 'Sin email registrado'}</p>
                                        </div>
                                    </div>
                                    
                                    {/* Gesti贸n de Roles (Solo Pastor) */}
                                    {userProfile.role === 'Pastor' && (
                                        <div className="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                            <h4 className="font-bold text-orange-800 mb-2">Gesti贸n de Accesos</h4>
                                            <div className="grid grid-cols-2 gap-2">
                                                <select className="border p-2 rounded bg-white" value={selected.role} onChange={(e)=>updateRole(selected.id, 'role', e.target.value)}>
                                                    {['Pastor','L铆der','Servidor General','Miembro'].map(r=><option key={r}>{r}</option>)}
                                                </select>
                                                <select className="border p-2 rounded bg-white" value={selected.ministry} onChange={(e)=>updateRole(selected.id, 'ministry', e.target.value)}>
                                                    {['Pastoral','Alabanza','EBD','J贸venes','General','Adolescentes'].map(m=><option key={m}>{m}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    )}

                                    {/* Visitas */}
                                    <div>
                                        <h4 className="font-bold mb-2">Historial de Visitas</h4>
                                        <div className="space-y-2 max-h-40 overflow-y-auto bg-slate-50 p-2 rounded">
                                            {selected.visitHistory && selected.visitHistory.length > 0 ? selected.visitHistory.map((v, i) => (
                                                <div key={i} className="bg-white p-2 rounded border text-sm">
                                                    <span className="font-bold">{v.date}</span>: {v.note}
                                                </div>
                                            )) : <p className="text-xs text-center text-slate-400">Sin visitas</p>}
                                        </div>
                                    </div>
                                    
                                    {userProfile.role === 'Pastor' && <Button variant="danger" className="w-full mt-4" onClick={() => { deleteData('members', selected.id); setSelected(null); }}>Eliminar Miembro</Button>}
                                </div>
                            )}
                        </Modal>

                        <Modal isOpen={isAdding} onClose={() => setIsAdding(false)} title="Agregar Miembro">
                            <div className="space-y-4">
                                <input className="w-full border p-2 rounded" placeholder="Nombre Completo" value={newMember.name} onChange={e=>setNewMember({...newMember, name: e.target.value})} />
                                <div>
                                    <label className="text-xs font-bold uppercase">Rol</label>
                                    <select className="w-full border p-2 rounded" value={newMember.role} onChange={e=>setNewMember({...newMember, role: e.target.value})}>
                                        {['Pastor','L铆der','Servidor General','Miembro'].map(r=><option key={r}>{r}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold uppercase">Ministerio</label>
                                    <select className="w-full border p-2 rounded" value={newMember.ministry} onChange={e=>setNewMember({...newMember, ministry: e.target.value})}>
                                        {['Pastoral','Alabanza','EBD','J贸venes','General','Adolescentes'].map(m=><option key={m}>{m}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold uppercase">Email de Login (Gmail)</label>
                                    <input type="email" className={`w-full border p-2 rounded ${isEmailRequired ? 'border-orange-300 bg-orange-50' : ''}`} placeholder={isEmailRequired ? "Requerido para acceso" : "Opcional"} value={newMember.email} onChange={e=>setNewMember({...newMember, email: e.target.value})} />
                                    {isEmailRequired && <p className="text-xs text-orange-600 mt-1">* Este rol requiere email para ingresar a la app.</p>}
                                </div>
                                <Button className="w-full" onClick={handleSaveMember}>Guardar</Button>
                            </div>
                        </Modal>
                    </div>
                );
            };

            // FINANZAS (TESORERA)
            const Finances = () => {
                const [isAdding, setIsAdding] = useState(false);
                const [type, setType] = useState('Culto');
                const [form, setForm] = useState({ date: new Date().toISOString().split('T')[0], cash: 0, transfer: 0, notes: '' });

                const handleSave = () => {
                    const finalData = { ...form, type, cash: Number(form.cash), transfer: Number(form.transfer) };
                    if(type === 'Gasto') { finalData.cash *= -1; finalData.transfer *= -1; }
                    addData('finances', finalData);
                    setIsAdding(false);
                    setForm({ date: new Date().toISOString().split('T')[0], cash: 0, transfer: 0, notes: '' });
                };

                const totalCash = finances.reduce((acc, f) => acc + (f.cash || 0), 0);
                const totalTransfer = finances.reduce((acc, f) => acc + (f.transfer || 0), 0);

                return (
                    <div className="space-y-6 fade-in">
                        <div className="grid grid-cols-2 gap-4">
                            <Card className="bg-emerald-50 border-emerald-200 text-emerald-800">
                                <p className="text-xs uppercase font-bold">Efectivo</p>
                                <p className="text-2xl font-bold">{formatCurrency(totalCash)}</p>
                            </Card>
                            <Card className="bg-blue-50 border-blue-200 text-blue-800">
                                <p className="text-xs uppercase font-bold">Banco / Transf.</p>
                                <p className="text-2xl font-bold">{formatCurrency(totalTransfer)}</p>
                            </Card>
                        </div>
                        <div className="flex gap-2 justify-end">
                            <Button variant="danger" onClick={()=>{setType('Gasto'); setIsAdding(true);}}>Gasto</Button>
                            <Button onClick={()=>{setType('Ingreso'); setIsAdding(true);}}>Ingreso</Button>
                            <Button onClick={()=>{setType('Culto'); setIsAdding(true);}}>Cierre Culto</Button>
                        </div>
                        
                        <div className="bg-white rounded-xl shadow border overflow-hidden">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                                    <tr><th className="p-3">Fecha</th><th className="p-3">Detalle</th><th className="p-3 text-right">Monto</th></tr>
                                </thead>
                                <tbody>
                                    {finances.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(f => (
                                        <tr key={f.id} className="border-t border-slate-100">
                                            <td className="p-3">{formatDate(f.date)}</td>
                                            <td className="p-3"><Badge type={f.type === 'Gasto' ? 'danger' : 'success'}>{f.type}</Badge> {f.notes}</td>
                                            <td className={`p-3 text-right font-mono font-bold ${(f.cash+f.transfer) < 0 ? 'text-red-500' : 'text-slate-700'}`}>{formatCurrency(f.cash + f.transfer)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <Modal isOpen={isAdding} onClose={()=>setIsAdding(false)} title={`Registrar ${type}`}>
                            <div className="space-y-4">
                                <input type="date" className="w-full border p-2 rounded" value={form.date} onChange={e=>setForm({...form, date:e.target.value})}/>
                                <input className="w-full border p-2 rounded" placeholder="Detalle / Notas" value={form.notes} onChange={e=>setForm({...form, notes:e.target.value})}/>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="text-xs font-bold">Efectivo</label><input type="number" className="w-full border p-2 rounded" value={form.cash} onChange={e=>setForm({...form, cash:e.target.value})}/></div>
                                    <div><label className="text-xs font-bold">Transferencia</label><input type="number" className="w-full border p-2 rounded" value={form.transfer} onChange={e=>setForm({...form, transfer:e.target.value})}/></div>
                                </div>
                                <Button className="w-full" onClick={handleSave}>Guardar</Button>
                            </div>
                        </Modal>
                    </div>
                );
            };

            // ALABANZA
            const Worship = () => {
                const [isAdding, setIsAdding] = useState(false);
                const [newSrv, setNewSrv] = useState({ date: '', theme: '', type: 'Culto', songs: [], team: {} });
                
                // M煤sicos disponibles
                const musicians = members.filter(m => m.ministry === 'Alabanza' || m.role === 'Pastor');

                const toggleMusician = (role, name) => {
                    const current = newSrv.team[role] || [];
                    const updated = current.includes(name) ? current.filter(n => n !== name) : [...current, name];
                    setNewSrv({ ...newSrv, team: { ...newSrv.team, [role]: updated } });
                };

                return (
                    <div className="space-y-6 fade-in">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Alabanza</h2>
                            <Button icon="Plus" onClick={() => setIsAdding(true)}>Planificar</Button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {worship.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(w => (
                                <Card key={w.id}>
                                    <div className="flex justify-between mb-2">
                                        <Badge type={w.type === 'Ensayo' ? 'default' : 'brand'}>{w.type}</Badge>
                                        <span className="text-xs font-bold text-slate-400">{formatDate(w.date)}</span>
                                        <button onClick={()=>deleteData('worship', w.id)} className="text-red-300 hover:text-red-500"><Icon name="Trash" size={16}/></button>
                                    </div>
                                    <h3 className="font-bold text-lg mb-2">{w.theme}</h3>
                                    <div className="bg-slate-50 p-2 rounded text-sm mb-2">
                                        <strong>Canciones:</strong> {w.songs?.join(', ')}
                                    </div>
                                </Card>
                            ))}
                        </div>
                        
                        <Modal isOpen={isAdding} onClose={()=>setIsAdding(false)} title="Planificar">
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-2">
                                    <select className="border p-2 rounded" value={newSrv.type} onChange={e=>setNewSrv({...newSrv, type:e.target.value})}>
                                        <option>Culto</option><option>Ensayo</option>
                                    </select>
                                    <input type="date" className="border p-2 rounded" onChange={e=>setNewSrv({...newSrv, date:e.target.value})}/>
                                </div>
                                <input className="w-full border p-2 rounded" placeholder="Tema" onChange={e=>setNewSrv({...newSrv, theme:e.target.value})}/>
                                <input className="w-full border p-2 rounded" placeholder="Canciones (separar con comas)" onBlur={e=>setNewSrv({...newSrv, songs:e.target.value.split(',')})}/>
                                
                                <div className="border-t pt-2">
                                    <p className="text-xs font-bold mb-2">Equipo</p>
                                    {['Vocal', 'Guitarra', 'Bateria', 'Bajo'].map(inst => (
                                        <div key={inst} className="mb-2">
                                            <p className="text-xs text-slate-500">{inst}</p>
                                            <div className="flex flex-wrap gap-1">
                                                {musicians.map(m => (
                                                    <button key={m.id} onClick={()=>toggleMusician(inst, m.name)} 
                                                        className={`text-xs px-2 py-1 border rounded ${(newSrv.team[inst]||[]).includes(m.name) ? 'bg-brand-600 text-white' : 'bg-white'}`}>
                                                        {m.name}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <Button className="w-full" onClick={() => { addData('worship', newSrv); setIsAdding(false); }}>Guardar</Button>
                            </div>
                        </Modal>
                    </div>
                );
            };

            // CALENDARIO REAL
            const CalendarView = () => {
                const [date, setDate] = useState(new Date());
                const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                const startDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();

                const events = [
                    ...worship.map(e => ({ date: e.date, title: e.theme, color: 'bg-orange-100 text-orange-700' })),
                    ...ebd.map(e => ({ date: e.date, title: 'EBD: ' + e.topic, color: 'bg-emerald-100 text-emerald-700' })),
                    ...youth.map(e => ({ date: e.date, title: 'J贸venes: ' + e.title, color: 'bg-purple-100 text-purple-700' }))
                ];

                const getEvents = (d) => {
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    return events.filter(e => e.date === dateStr);
                };

                return (
                    <div className="h-full flex flex-col fade-in">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold">Calendario</h2>
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={() => setDate(new Date(date.getFullYear(), date.getMonth() - 1, 1))}>&lt;</Button>
                                <span className="font-bold text-lg min-w-[150px] text-center">{date.toLocaleDateString('es-AR', { month: 'long', year: 'numeric' })}</span>
                                <Button variant="secondary" onClick={() => setDate(new Date(date.getFullYear(), date.getMonth() + 1, 1))}>&gt;</Button>
                            </div>
                        </div>
                        <div className="bg-white rounded-xl shadow border flex-1 grid grid-cols-7 grid-rows-6">
                            {['Dom','Lun','Mar','Mi茅','Jue','Vie','S谩b'].map(d => <div key={d} className="p-2 text-center text-xs font-bold uppercase border-b bg-slate-50">{d}</div>)}
                            {Array.from({ length: startDay }).map((_, i) => <div key={'empty'+i} className="border-b border-r bg-slate-50/30"></div>)}
                            {Array.from({ length: daysInMonth }).map((_, i) => (
                                <div key={i} className="border-b border-r p-1 relative min-h-[80px]">
                                    <span className="text-xs font-bold text-slate-400 absolute top-1 right-2">{i + 1}</span>
                                    <div className="mt-4 space-y-1">
                                        {getEvents(i+1).map((e, idx) => (
                                            <div key={idx} className={`text-[10px] px-1 rounded truncate ${e.color}`}>{e.title}</div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // JVENES & EBD (Gen茅ricos)
            const GenericMinistry = ({ title, col, fields }) => {
                const [isAdding, setIsAdding] = useState(false);
                const [form, setForm] = useState({});
                const items = col === 'ebd' ? ebd : youth;

                return (
                    <div className="space-y-6 fade-in">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">{title}</h2>
                            <Button icon="Plus" onClick={()=>setIsAdding(true)}>Nuevo</Button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {items.map(i => (
                                <Card key={i.id}>
                                    <div className="flex justify-between">
                                        <h3 className="font-bold">{i.topic || i.title}</h3>
                                        <span className="text-xs text-slate-400">{formatDate(i.date)}</span>
                                    </div>
                                    <p className="text-sm text-slate-500 mt-1">{i.teachers?.join(', ') || i.location}</p>
                                    <Button variant="secondary" className="mt-2 text-xs py-1" onClick={()=>deleteData(col, i.id)}>Eliminar</Button>
                                </Card>
                            ))}
                        </div>
                        <Modal isOpen={isAdding} onClose={()=>setIsAdding(false)} title={`Nuevo en ${title}`}>
                            <div className="space-y-4">
                                {fields.map(f => (
                                    <input key={f.key} className="w-full border p-2 rounded" placeholder={f.label} type={f.type || 'text'} 
                                        onChange={e => setForm({...form, [f.key]: f.type==='array'?e.target.value.split(','):e.target.value})} />
                                ))}
                                <Button className="w-full" onClick={()=>{addData(col, form); setIsAdding(false);}}>Guardar</Button>
                            </div>
                        </Modal>
                    </div>
                );
            };

            // --- NAVEGACIN ---
            const NavItem = ({ id, label, icon }) => (
                <button onClick={() => { setActiveTab(id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all mb-1 ${activeTab === id ? 'bg-brand-600 text-white shadow-lg' : 'text-brand-100/70 hover:bg-brand-800 hover:text-white'}`}>
                    <Icon name={icon} /> {label}
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <aside className={`fixed md:relative z-40 w-72 bg-brand-900 text-white h-full flex flex-col transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="p-6">
                            <div className="flex items-center gap-3 mb-8"><div className="bg-white/10 p-2 rounded-lg"><Icon name="Home" /></div><span className="font-bold text-lg">Conquistadores</span></div>
                            <nav>
                                <NavItem id="dashboard" icon="Home" label="Inicio" />
                                <NavItem id="calendar" icon="Calendar" label="Calendario" />
                                <NavItem id="directory" icon="Users" label="Directorio" />
                                <div className="my-4 px-4 text-xs font-bold text-brand-500/60 uppercase tracking-widest">Ministerios</div>
                                {(userProfile.role === 'Pastor' || userProfile.ministry === 'Alabanza') && <NavItem id="worship" icon="Music" label="Alabanza" />}
                                {(userProfile.role === 'Pastor' || userProfile.ministry === 'EBD') && <NavItem id="ebd" icon="Book" label="Escuela B铆blica" />}
                                {(userProfile.role === 'Pastor' || userProfile.ministry === 'J贸venes') && <NavItem id="youth" icon="Smile" label="J贸venes" />}
                                {userProfile.role === 'Pastor' && (
                                    <>
                                        <div className="my-4 px-4 text-xs font-bold text-brand-500/60 uppercase tracking-widest">Admin</div>
                                        <NavItem id="finances" icon="Wallet" label="Tesorer铆a" />
                                        <NavItem id="messages" icon="Mail" label="Mensajer铆a" />
                                    </>
                                )}
                            </nav>
                        </div>
                        <div className="mt-auto p-6 bg-brand-950 flex items-center justify-between">
                            <div className="flex items-center gap-3 overflow-hidden">
                                {userProfile.photo && <img src={userProfile.photo} className="w-8 h-8 rounded-full"/>}
                                <div className="truncate"><p className="font-bold text-sm truncate">{userProfile.name}</p><p className="text-[10px] text-brand-400 uppercase">{userProfile.role}</p></div>
                            </div>
                            <button onClick={handleLogout}><Icon name="LogOut" className="text-brand-400 hover:text-white"/></button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto bg-slate-50 w-full relative">
                        <header className="md:hidden bg-white p-4 sticky top-0 z-30 shadow-sm flex justify-between items-center">
                            <span className="font-bold text-brand-900">App</span>
                            <button onClick={() => setSidebarOpen(true)} className="text-slate-600"><Icon name="Menu" /></button>
                        </header>
                        <div className="p-4 md:p-8 max-w-7xl mx-auto pb-24 h-full">
                            {activeTab === 'dashboard' && <Dashboard />}
                            {activeTab === 'directory' && <Directory />}
                            {activeTab === 'finances' && <Finances />}
                            {activeTab === 'worship' && <Worship />}
                            {activeTab === 'calendar' && <CalendarView />}
                            {activeTab === 'ebd' && <GenericMinistry title="Escuela B铆blica" col="ebd" fields={[{key:'date',label:'Fecha',type:'date'},{key:'topic',label:'Tema'},{key:'teachers',label:'Maestros (Sep. comas)',type:'array'}]} />}
                            {activeTab === 'youth' && <GenericMinistry title="J贸venes" col="youth" fields={[{key:'date',label:'Fecha',type:'date'},{key:'title',label:'T铆tulo Evento'},{key:'location',label:'Lugar'}]} />}
                            {activeTab === 'messages' && (
                                <div className="fade-in">
                                    <h2 className="text-2xl font-bold mb-4">Mensajer铆a</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <Card>
                                            <h3 className="font-bold mb-2">Enviar Mensaje</h3>
                                            <textarea className="w-full border p-2 rounded h-32 mb-2" placeholder="Escribe aqu铆..."></textarea>
                                            <Button icon="Mail" onClick={()=>alert("Mensaje simulado enviado.")}>Enviar</Button>
                                        </Card>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setSidebarOpen(false)}></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
