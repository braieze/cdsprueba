<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Conquistadores App - Gesti√≥n Integral</title>

    <!-- ====================================================================================
         SECUENCIA CR√çTICA DE CARGA (NO MODIFICAR)
         ==================================================================================== -->
    
    <!-- 1. React Core (v18) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 2. PropTypes (Requerido por Recharts ANTES de cargar Recharts) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- 3. Recharts (Librer√≠a Gr√°fica) -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

    <!-- 4. Babel (Compilador JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 6. Firebase SDKs (Compat v9.23.0) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Configuraci√≥n de Estilos y Branding -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        church: {
                            navy: '#1A438D', // Primario
                            gold: '#F5C71D', // Acento
                            50: '#f0f4fd',
                            100: '#e4ebfa',
                            600: '#1A438D',
                            700: '#153673',
                            800: '#142d5f',
                        }
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos espec√≠ficos para inputs y formularios */
        .input-std { @apply w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-church-navy focus:ring-2 focus:ring-church-navy/20 outline-none transition-all text-sm font-medium; }
        .label-std { @apply block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5 ml-1; }
        .btn-action { @apply active:scale-95 transition-transform; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ====================================================================================
        // 1. INICIALIZACI√ìN Y UTILIDADES
        // ====================================================================================
        const { useState, useEffect, useMemo, useContext, createContext, useCallback, useRef } = React;
        
        // --- FIX RECHARTS: Acceso seguro al objeto global ---
        const RechartsObj = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Cell } = RechartsObj;

        // --- Configuraci√≥n Firebase (Variables Globales) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'conquistadores-app-prod';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Fallback config por si falla la inyecci√≥n (opcional, solo dev)
             apiKey: "AIzaSyDXK_EcXsFGhRmXfkKG8SMdsM69c4PNfHw", authDomain: "conquistadoresapp.firebaseapp.com", projectId: "conquistadoresapp"
        };
        
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Firebase Init Error:", e);
            }
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Iconos SVG (Lucide-like) Expandidos ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Menu: <path d="M4 6h16M4 12h16M4 18h16" />,
                X: <path d="M18 6L6 18M6 6l12 12" />,
                Home: <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" />,
                Users: <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />,
                Music: <path d="M9 18V5l12-2v13" />,
                Briefcase: <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />,
                Book: <path d="M4 19.5A2.5 2.5 0 016.5 17H20" />,
                Smile: <circle cx="12" cy="12" r="10" />,
                DollarSign: <path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6" />,
                Bell: <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9" />,
                Calendar: <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />,
                ChevronLeft: <path d="M15 18l-6-6 6-6" />,
                ChevronRight: <path d="M9 18l6-6-6-6" />,
                Plus: <path d="M12 5v14M5 12h14" />,
                Trash: <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />,
                Edit: <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />,
                Check: <polyline points="20 6 9 17 4 12" />,
                LogOut: <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />,
                Search: <React.Fragment><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></React.Fragment>,
                Filter: <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />,
                Mic: <React.Fragment><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" /><path d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" y1="19" x2="12" y2="23" /><line x1="8" y1="23" x2="16" y2="23" /></React.Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="2" />}
                </svg>
            );
        };

        // --- Helpers ---
        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        const getMonthChips = () => {
            const today = new Date();
            let chips = [];
            // Generar 12 meses: 4 atr√°s y 7 adelante
            for (let i = -4; i <= 7; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
                chips.push(d);
            }
            return chips;
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            const date = new Date(y, m - 1, d);
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        };
        
        const getDayName = (dateStr) => {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            const date = new Date(y, m - 1, d);
            return date.toLocaleDateString('es-ES', { weekday: 'short' });
        }

        const formatMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(val);

        // ====================================================================================
        // 2. COMPONENTES UI REUTILIZABLES
        // ====================================================================================
        
        const Modal = ({ isOpen, onClose, title, children, footer, size = "md" }) => {
            if (!isOpen) return null;
            const sizeClasses = {
                sm: "max-w-md",
                md: "max-w-xl",
                lg: "max-w-4xl"
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/70 backdrop-blur-sm fade-in">
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${sizeClasses[size]} max-h-[95vh] overflow-hidden flex flex-col`}>
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-church-navy text-white">
                            <h3 className="font-bold text-lg tracking-wide">{title}</h3>
                            <button onClick={onClose} className="p-1.5 hover:bg-white/20 rounded-full transition-colors"><Icon name="X" /></button>
                        </div>
                        <div className="p-6 flex-1 overflow-y-auto bg-slate-50">
                            {children}
                        </div>
                        {footer && (
                            <div className="p-4 border-t border-slate-100 bg-white flex justify-end gap-3 rounded-b-2xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                                {footer}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Button = ({ children, onClick, variant = 'primary', className = "", icon, disabled = false, type="button" }) => {
            const styles = {
                primary: "bg-church-navy text-white hover:bg-church-800 shadow-lg shadow-church-navy/30",
                secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50",
                accent: "bg-church-gold text-church-navy font-bold hover:bg-yellow-400 shadow-lg shadow-yellow-500/20",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-200"
            };
            return (
                <button type={type} disabled={disabled} onClick={onClick} className={`btn-action flex items-center justify-center gap-2 px-5 py-2.5 rounded-xl font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed ${styles[variant]} ${className}`}>
                    {icon && <Icon name={icon} size={18} />}
                    {children}
                </button>
            );
        };

        const Input = ({ label, type = "text", value, onChange, placeholder, required = false, name }) => (
            <div className="mb-4">
                <label className="label-std">{label} {required && <span className="text-red-500">*</span>}</label>
                <input 
                    name={name}
                    type={type} 
                    value={value} 
                    onChange={onChange} 
                    placeholder={placeholder}
                    className="input-std"
                />
            </div>
        );

        const Select = ({ label, value, onChange, options, name }) => (
            <div className="mb-4">
                <label className="label-std">{label}</label>
                <select 
                    name={name}
                    value={value} 
                    onChange={onChange} 
                    className="input-std appearance-none"
                >
                    {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
            </div>
        );

        // ====================================================================================
        // 3. LOGICA PRINCIPAL (APP)
        // ====================================================================================

        const App = () => {
            // --- ESTADOS GLOBALES ---
            const [user, setUser] = useState(null); 
            const [userData, setUserData] = useState(null); 
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedMonth, setSelectedMonth] = useState(new Date()); 
            
            // --- DATOS (Colecciones) ---
            const [people, setPeople] = useState([]);
            const [worshipEvents, setWorshipEvents] = useState([]);
            const [serverEvents, setServerEvents] = useState([]);
            const [ebdEvents, setEbdEvents] = useState([]);
            const [youthEvents, setYouthEvents] = useState([]);
            const [finances, setFinances] = useState([]);
            const [songs, setSongs] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [messages, setMessages] = useState([]);

            // --- UI States ---
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [globalModalEvent, setGlobalModalEvent] = useState(null); 
            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: '', data: null }); 

            // --- AUTHENTICATION INIT ---
            useEffect(() => {
                const initAuth = async () => {
                    const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialToken) {
                        await auth.signInWithCustomToken(initialToken);
                    } else {
                        // Fallback an√≥nimo si no hay token
                        await auth.signInAnonymously();
                    }
                };
                initAuth();

                return auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        // Buscar perfil en Firestore
                        const docPath = `artifacts/${appId}/public/data/people`;
                        let doc = await db.collection(docPath).doc(u.uid).get();
                        
                        if (doc.exists) {
                            setUserData({ id: doc.id, ...doc.data() });
                        } else {
                            // Intento de buscar por email si el ID no coincide (para migraciones)
                            if (u.email) {
                                const snapshot = await db.collection(docPath).where('email', '==', u.email).limit(1).get();
                                if (!snapshot.empty) {
                                    setUserData({ id: snapshot.docs[0].id, ...snapshot.docs[0].data() });
                                    return;
                                }
                            }
                            // Crear perfil default
                            const newProfile = {
                                name: u.displayName || 'Nuevo Usuario',
                                role: 'Servidor',
                                email: u.email || '',
                                createdAt: new Date().toISOString()
                            };
                            await db.collection(docPath).doc(u.uid).set(newProfile);
                            setUserData({ id: u.uid, ...newProfile });
                        }
                    }
                });
            }, []);

            // --- DATA FETCHING (Unificado) ---
            useEffect(() => {
                if (!user) return;
                
                const basePath = `artifacts/${appId}/public/data`;
                const subs = [];
                
                const sub = (col, setter) => {
                    subs.push(db.collection(`${basePath}/${col}`).onSnapshot(snap => {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        setter(data);
                    }, err => console.error(`Error fetching ${col}:`, err)));
                };

                sub('people', setPeople);
                sub('worship_events', setWorshipEvents);
                sub('server_events', setServerEvents);
                sub('ebd_events', setEbdEvents);
                sub('youth_events', setYouthEvents);
                sub('finances', setFinances);
                sub('songs', setSongs);
                sub('tasks', setTasks);
                sub('messages', setMessages);

                return () => subs.forEach(unsub => unsub());
            }, [user]);

            // --- FILTROS DE MES ---
            const filterByMonth = (list) => {
                if (!list) return [];
                const y = selectedMonth.getFullYear();
                const m = selectedMonth.getMonth(); 
                return list.filter(item => {
                    if (!item.date) return false;
                    // Comparar string YYYY-MM
                    const itemDate = item.date.substring(0, 7); // "2023-10"
                    const filterDate = `${y}-${String(m+1).padStart(2,'0')}`;
                    return itemDate === filterDate;
                });
            };

            // --- PERMISOS ---
            const canEdit = (ministry) => {
                if (!userData) return false;
                if (userData.role === 'Pastor') return true;
                if (userData.role.includes(ministry)) return true; // Ej: "L√≠der de Alabanza"
                return false;
            };

            // --- CRUD ACTIONS ---
            const handleSave = async (collection, data, id = null) => {
                const path = `artifacts/${appId}/public/data/${collection}`;
                try {
                    // Limpieza de datos undefined
                    const cleanData = JSON.parse(JSON.stringify(data));
                    
                    if (id) {
                        await db.collection(path).doc(id).update(cleanData);
                    } else {
                        await db.collection(path).add({ ...cleanData, createdAt: new Date().toISOString() });
                    }
                    setModalConfig({ isOpen: false, type: '', data: null });
                } catch (e) {
                    console.error(e);
                    // Fallback visual simple
                    const errDiv = document.createElement('div');
                    errDiv.innerHTML = `<div class="fixed top-4 right-4 bg-red-500 text-white p-4 rounded shadow-lg z-[60]">Error: ${e.message}</div>`;
                    document.body.appendChild(errDiv);
                    setTimeout(()=>errDiv.remove(), 3000);
                }
            };

            const handleDelete = async (collection, id) => {
                if(!id) return;
                // Confirmaci√≥n Custom (No alert)
                setModalConfig({ 
                    isOpen: true, 
                    type: 'confirm_delete', 
                    data: { collection, id } 
                });
            };

            const confirmDelete = async () => {
                const { collection, id } = modalConfig.data;
                const path = `artifacts/${appId}/public/data/${collection}`;
                await db.collection(path).doc(id).delete();
                setModalConfig({ isOpen: false, type: '', data: null });
            };

            // --- VISTA GLOBAL DE EVENTO (MODAL UNIFICADO) ---
            const openGlobalEvent = (date, baseEvent) => {
                const matches = {
                    base: baseEvent,
                    worship: worshipEvents.find(e => e.date === date),
                    server: serverEvents.find(e => e.date === date),
                    ebd: ebdEvents.find(e => e.date === date),
                    youth: youthEvents.find(e => e.date === date)
                };
                setGlobalModalEvent(matches);
            };

            // =================================================================================
            // 4. SUB-COMPONENTES DE PANTALLA
            // =================================================================================

            // --- COMPONENTE: NAVEGACI√ìN MENSUAL (CHIPS) ---
            const MonthNav = () => (
                <div className="flex overflow-x-auto gap-2 py-3 px-4 hide-scroll bg-white sticky top-0 z-20 shadow-sm border-b border-slate-100 items-center">
                    <Icon name="Calendar" className="text-church-navy mr-2 flex-shrink-0" />
                    {getMonthChips().map((d, i) => {
                        const isSelected = d.getMonth() === selectedMonth.getMonth() && d.getFullYear() === selectedMonth.getFullYear();
                        return (
                            <button 
                                key={i}
                                onClick={() => setSelectedMonth(d)}
                                className={`px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all border ${isSelected ? 'bg-church-navy text-white border-church-navy shadow-lg shadow-church-navy/20' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:border-slate-300'}`}
                            >
                                {MONTHS[d.getMonth()].substring(0,3)} {d.getFullYear() !== new Date().getFullYear() && d.getFullYear()}
                            </button>
                        );
                    })}
                </div>
            );

            // --- COMPONENTE: DASHBOARD ---
            const DashboardView = () => {
                // C√°lculo de Equidad (Recharts)
                const serverStats = useMemo(() => {
                    const counts = {};
                    serverEvents.forEach(evt => {
                        Object.values(evt.assignments || {}).forEach(name => {
                            if (name) counts[name] = (counts[name] || 0) + 1;
                        });
                    });
                    // Agregar Alabanza tambi√©n
                    worshipEvents.forEach(evt => {
                         Object.values(evt.assignments || {}).forEach(name => {
                            if (name) counts[name] = (counts[name] || 0) + 1;
                        });
                    });

                    return Object.entries(counts)
                        .map(([name, count]) => ({ name, count }))
                        .sort((a,b) => b.count - a.count)
                        .slice(0, 10);
                }, [serverEvents, worshipEvents]);

                const unreadMessages = messages.filter(m => (m.to === 'all' || m.to === userData?.id) && !(m.readBy || []).includes(userData?.id)).length;
                const myPendingTasks = tasks.filter(t => t.assignedToId === userData?.id && t.status === 'Pendiente').length;

                return (
                    <div className="space-y-6 fade-in pb-10">
                        {/* Header Personal */}
                        <div className="bg-gradient-to-r from-church-navy to-church-700 rounded-3xl p-8 text-white relative overflow-hidden shadow-xl">
                            <div className="relative z-10">
                                <h1 className="text-3xl font-extrabold mb-2">Hola, {userData?.name?.split(' ')[0] || 'Conquistador'}</h1>
                                <p className="text-church-100 font-medium">Bienvenido a tu panel de gesti√≥n.</p>
                                <div className="mt-6 flex gap-3">
                                    <div onClick={() => setActiveTab('inbox')} className="bg-white/10 backdrop-blur-sm border border-white/20 px-4 py-2 rounded-xl flex items-center gap-2 cursor-pointer hover:bg-white/20 transition-colors">
                                        <Icon name="Bell" size={16} />
                                        <span className="font-bold">{unreadMessages} Mensajes</span>
                                    </div>
                                    <div onClick={() => setActiveTab('inbox')} className="bg-white/10 backdrop-blur-sm border border-white/20 px-4 py-2 rounded-xl flex items-center gap-2 cursor-pointer hover:bg-white/20 transition-colors">
                                        <Icon name="Check" size={16} />
                                        <span className="font-bold">{myPendingTasks} Tareas</span>
                                    </div>
                                </div>
                            </div>
                            <Icon name="Home" size={150} className="absolute -right-6 -bottom-6 text-white/5 rotate-12" />
                        </div>

                        {/* Quick Stats Grid */}
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center items-center text-center hover:border-church-gold transition-colors cursor-pointer" onClick={() => setActiveTab('directory')}>
                                <div className="bg-blue-50 text-church-navy p-3 rounded-full mb-2"><Icon name="Users" /></div>
                                <span className="text-2xl font-black text-slate-800">{people.length}</span>
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Miembros</span>
                            </div>
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center items-center text-center hover:border-church-gold transition-colors cursor-pointer" onClick={() => setActiveTab('servers')}>
                                <div className="bg-green-50 text-green-600 p-3 rounded-full mb-2"><Icon name="Briefcase" /></div>
                                <span className="text-2xl font-black text-slate-800">{serverEvents.length}</span>
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Eventos</span>
                            </div>
                        </div>

                        {/* Gr√°fico Recharts (Solo Lideres/Pastores) */}
                        {userData?.role !== 'Servidor' && serverStats.length > 0 && BarChart && (
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h3 className="font-bold text-lg mb-6 text-church-navy flex items-center gap-2">
                                    <Icon name="Filter" size={18} /> Rotaci√≥n de Servicio
                                </h3>
                                <div className="h-64 w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={serverStats}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="name" tick={{fontSize: 10, fill: '#64748b'}} interval={0} />
                                            <YAxis allowDecimals={false} tick={{fontSize: 10, fill: '#64748b'}} />
                                            <Tooltip 
                                                cursor={{fill: '#f8fafc'}} 
                                                contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'}}
                                            />
                                            <Bar dataKey="count" fill="#1A438D" radius={[4, 4, 0, 0]} barSize={32}>
                                                {serverStats.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={index < 3 ? '#F5C71D' : '#1A438D'} />
                                                ))}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // --- COMPONENTE: BANDEJA DE ENTRADA (MESSAGING + TASKS) ---
            const InboxView = () => {
                const [filter, setFilter] = useState('all'); // all, tasks, messages
                
                // Procesar Tareas
                const myTasks = tasks.filter(t => t.assignedToId === userData?.id || t.assignedToName === userData?.name);
                // Procesar Mensajes
                const myMessages = messages.filter(m => m.to === 'all' || m.to === userData?.id).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

                const combined = [
                    ...myTasks.map(t => ({...t, type: 'task', sortDate: t.createdAt})),
                    ...myMessages.map(m => ({...m, type: 'message', sortDate: m.createdAt}))
                ].sort((a,b) => new Date(b.sortDate) - new Date(a.sortDate));

                const filteredList = filter === 'all' ? combined : combined.filter(i => i.type === filter);

                const markRead = async (msg) => {
                    const currentReads = msg.readBy || [];
                    if (!currentReads.includes(userData.id)) {
                        await db.collection(`artifacts/${appId}/public/data/messages`).doc(msg.id).update({
                            readBy: [...currentReads, userData.id]
                        });
                    }
                };

                const completeTask = async (task) => {
                    await db.collection(`artifacts/${appId}/public/data/tasks`).doc(task.id).update({ status: 'Completado' });
                };

                return (
                    <div className="space-y-4 fade-in">
                        <div className="flex justify-between items-center mb-2">
                            <h2 className="text-2xl font-bold text-church-navy">Buz√≥n</h2>
                            {(userData?.role === 'Pastor' || userData?.role.includes('L√≠der')) && (
                                <Button icon="Plus" onClick={() => setModalConfig({ isOpen: true, type: 'compose_message' })} className="text-xs px-3">Nuevo</Button>
                            )}
                        </div>

                        <div className="flex gap-2 mb-4 overflow-x-auto hide-scroll">
                            {['all', 'message', 'task'].map(f => (
                                <button key={f} onClick={() => setFilter(f)} className={`px-4 py-2 rounded-lg text-sm font-bold capitalize transition-colors ${filter === f ? 'bg-slate-800 text-white' : 'bg-white border border-slate-200 text-slate-500'}`}>
                                    {f === 'all' ? 'Todo' : f === 'message' ? 'Mensajes' : 'Tareas'}
                                </button>
                            ))}
                        </div>

                        <div className="space-y-3">
                            {filteredList.length === 0 && <div className="text-center py-10 text-slate-400">No hay notificaciones.</div>}
                            
                            {filteredList.map(item => {
                                if (item.type === 'task') {
                                    return (
                                        <div key={item.id} className="bg-white p-4 rounded-xl border-l-4 border-l-church-gold shadow-sm">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="bg-church-gold/20 text-church-navy px-2 py-0.5 rounded text-[10px] font-bold uppercase">Tarea</span>
                                                        <span className="text-xs text-slate-400">{formatDate(item.createdAt?.substring(0,10))}</span>
                                                    </div>
                                                    <h4 className={`font-bold text-slate-800 ${item.status === 'Completado' ? 'line-through opacity-50' : ''}`}>{item.description}</h4>
                                                    <p className="text-xs text-slate-500 mt-1">Asignado por: {item.createdBy}</p>
                                                </div>
                                                {item.status !== 'Completado' ? (
                                                    <button onClick={() => completeTask(item)} className="p-2 bg-slate-100 hover:bg-green-100 text-slate-400 hover:text-green-600 rounded-lg transition-colors"><Icon name="Check" /></button>
                                                ) : <Icon name="Check" className="text-green-500" />}
                                            </div>
                                        </div>
                                    );
                                } else {
                                    const isRead = (item.readBy || []).includes(userData?.id);
                                    return (
                                        <details key={item.id} className="group bg-white rounded-xl border border-slate-100 shadow-sm open:shadow-md transition-all" onClick={() => !isRead && markRead(item)}>
                                            <summary className="flex justify-between items-center p-4 cursor-pointer list-none">
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-full ${isRead ? 'bg-slate-100 text-slate-400' : 'bg-blue-100 text-blue-600'}`}>
                                                        <Icon name="Bell" size={18} />
                                                    </div>
                                                    <div>
                                                        <p className={`text-sm ${isRead ? 'font-medium text-slate-600' : 'font-bold text-slate-900'}`}>{item.subject || 'Mensaje Nuevo'}</p>
                                                        <p className="text-xs text-slate-400">{formatDate(item.createdAt?.substring(0,10))} ‚Ä¢ De: {item.fromName}</p>
                                                    </div>
                                                </div>
                                                <Icon name="ChevronRight" size={16} className="text-slate-300 group-open:rotate-90 transition-transform" />
                                            </summary>
                                            <div className="px-4 pb-4 pt-0 border-t border-slate-50 mt-2">
                                                <p className="text-sm text-slate-600 whitespace-pre-line mt-4">{item.content}</p>
                                            </div>
                                        </details>
                                    );
                                }
                            })}
                        </div>
                    </div>
                );
            };

            // --- COMPONENTE: TESORER√çA (SOLO PASTOR) ---
            const FinancesView = () => {
                if (userData?.role !== 'Pastor') return <div className="p-10 text-center text-slate-400 bg-slate-100 rounded-xl m-4">üö´ Acceso Restringido</div>;

                const filtered = filterByMonth(finances);
                // C√°lculos
                const totalTithes = filtered.reduce((sum, item) => sum + (Number(item.tithes) || 0), 0);
                const totalOfferings = filtered.reduce((sum, item) => sum + (Number(item.offerings) || 0), 0);
                const totalIncome = filtered.filter(i => i.type === 'Ingreso').reduce((sum, i) => sum + (Number(i.amount) || 0), 0);
                const totalExpenses = filtered.filter(i => i.type === 'Gasto').reduce((sum, i) => sum + (Number(i.amount) || 0), 0);
                
                const grandTotal = totalTithes + totalOfferings + totalIncome;

                return (
                    <div className="space-y-6 fade-in">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-church-navy">Tesorer√≠a</h2>
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={() => setModalConfig({ isOpen: true, type: 'finance_income' })} className="text-xs px-3">Ingreso</Button>
                                <Button variant="danger" onClick={() => setModalConfig({ isOpen: true, type: 'finance_expense' })} className="text-xs px-3">Gasto</Button>
                            </div>
                        </div>

                        {/* Tarjetas Resumen */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-green-500">
                                <p className="text-xs font-bold text-slate-400 uppercase">Ingresos Totales (Mes)</p>
                                <p className="text-2xl font-black text-slate-800">{formatMoney(grandTotal)}</p>
                                <div className="text-xs text-slate-500 mt-1 flex gap-2">
                                    <span>Diezmos: {formatMoney(totalTithes)}</span>
                                    <span>Ofrendas: {formatMoney(totalOfferings)}</span>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-red-500">
                                <p className="text-xs font-bold text-slate-400 uppercase">Gastos (Mes)</p>
                                <p className="text-2xl font-black text-slate-800">{formatMoney(totalExpenses)}</p>
                            </div>
                            <div className="bg-church-navy p-4 rounded-xl shadow-lg text-white">
                                <p className="text-xs font-bold text-church-100 uppercase">Balance Neto</p>
                                <p className="text-3xl font-black">{formatMoney(grandTotal - totalExpenses)}</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs border-b border-slate-200">
                                    <tr>
                                        <th className="p-4">Fecha</th>
                                        <th className="p-4">Concepto</th>
                                        <th className="p-4 text-right">Monto</th>
                                        <th className="p-4 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).map(f => {
                                        const amount = (Number(f.tithes)||0) + (Number(f.offerings)||0) + (Number(f.amount)||0);
                                        return (
                                            <tr key={f.id} className="hover:bg-slate-50 transition-colors">
                                                <td className="p-4 font-medium text-slate-600">{formatDate(f.date)}</td>
                                                <td className="p-4">
                                                    <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase mr-2 ${f.type === 'Gasto' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{f.type}</span>
                                                    {f.notes}
                                                </td>
                                                <td className={`p-4 text-right font-mono font-bold ${f.type === 'Gasto' ? 'text-red-600' : 'text-slate-700'}`}>
                                                    {formatMoney(amount)}
                                                </td>
                                                <td className="p-4">
                                                    <button onClick={() => handleDelete('finances', f.id)} className="text-slate-300 hover:text-red-500"><Icon name="Trash" size={16} /></button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                    {filtered.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">Sin movimientos este mes.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            // --- COMPONENTE: LISTAS DE MINISTERIOS (GEN√âRICO) ---
            const MinistryView = ({ title, events, collection, ministryKey, icon }) => {
                const filtered = filterByMonth(events);
                const hasPermission = canEdit(ministryKey);

                return (
                    <div className="space-y-6 fade-in">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                <Icon name={icon} className="text-church-navy" /> {title}
                            </h2>
                            {hasPermission && <Button icon="Plus" onClick={() => setModalConfig({ isOpen: true, type: collection })}>Planificar</Button>}
                        </div>

                        {filtered.length === 0 && (
                            <div className="flex flex-col items-center justify-center py-16 bg-white rounded-2xl border-2 border-dashed border-slate-200">
                                <Icon name="Calendar" size={48} className="text-slate-200 mb-4" />
                                <p className="text-slate-400 font-medium">No hay eventos programados.</p>
                                {hasPermission && <button onClick={() => setModalConfig({ isOpen: true, type: collection })} className="mt-2 text-church-navy font-bold text-sm hover:underline">Crear el primero</button>}
                            </div>
                        )}

                        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                            {filtered.sort((a,b) => new Date(a.date) - new Date(b.date)).map(evt => (
                                <div key={evt.id} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:border-church-gold transition-all cursor-pointer group relative flex flex-col h-full" onClick={() => openGlobalEvent(evt.date, evt)}>
                                    
                                    {/* Cabecera Tarjeta */}
                                    <div className="flex justify-between items-start mb-4">
                                        <div className="bg-slate-50 px-3 py-2 rounded-xl text-center border border-slate-100 min-w-[60px]">
                                            <div className="text-[10px] font-bold text-slate-400 uppercase">{getDayName(evt.date)}</div>
                                            <div className="text-xl font-black text-church-navy">{evt.date.split('-')[2]}</div>
                                        </div>
                                        {hasPermission && (
                                            <div className="flex gap-1" onClick={e => e.stopPropagation()}>
                                                <button onClick={() => setModalConfig({ isOpen: true, type: collection, data: evt })} className="p-2 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-church-navy transition-colors"><Icon name="Edit" size={16} /></button>
                                                <button onClick={() => handleDelete(collection, evt.id)} className="p-2 hover:bg-red-50 rounded-lg text-slate-400 hover:text-red-500 transition-colors"><Icon name="Trash" size={16} /></button>
                                            </div>
                                        )}
                                    </div>

                                    {/* Contenido */}
                                    <div className="flex-1">
                                        <h3 className="font-bold text-lg text-slate-800 leading-tight mb-2">{evt.title || evt.theme || 'Servicio General'}</h3>
                                        <div className="flex flex-wrap gap-2 mb-3">
                                            <span className="inline-flex items-center gap-1 text-xs font-medium bg-slate-100 text-slate-600 px-2 py-1 rounded">
                                                <Icon name="Calendar" size={12}/> {evt.time} hs
                                            </span>
                                            {evt.preacher && (
                                                <span className="inline-flex items-center gap-1 text-xs font-bold bg-church-gold/10 text-church-800 px-2 py-1 rounded border border-church-gold/20">
                                                    <Icon name="Mic" size={12}/> {evt.preacher}
                                                </span>
                                            )}
                                        </div>
                                        
                                        {/* Resumen Equipo (Solo muestra conteo o primeros nombres) */}
                                        <div className="pt-3 border-t border-slate-50 text-xs text-slate-500">
                                            {collection === 'worship_events' && evt.songsText && <p className="line-clamp-1 italic">üéµ {evt.songsText}</p>}
                                            {collection === 'server_events' && evt.assignments && (
                                                <div className="flex gap-2 mt-1">
                                                    <span className="bg-green-50 text-green-700 px-1.5 py-0.5 rounded">Recepci√≥n: {evt.assignments['Recepci√≥n'] || '--'}</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // --- COMPONENTE: DIRECTORIO (CRUD COMPLETO) ---
            const DirectoryView = () => {
                const [search, setSearch] = useState("");
                // Filtro local
                const filtered = people.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || p.email?.toLowerCase().includes(search.toLowerCase()));

                return (
                    <div className="space-y-6 fade-in">
                        <div className="flex flex-col md:flex-row justify-between gap-4">
                            <h2 className="text-2xl font-bold text-slate-800">Directorio de Miembros</h2>
                            <div className="flex gap-2 w-full md:w-auto">
                                <div className="relative flex-1 md:w-64">
                                    <Icon name="Search" size={16} className="absolute left-3 top-3.5 text-slate-400" />
                                    <input 
                                        type="text" 
                                        placeholder="Buscar por nombre..." 
                                        className="pl-9 input-std mb-0" 
                                        value={search}
                                        onChange={e => setSearch(e.target.value)}
                                    />
                                </div>
                                <Button icon="Plus" onClick={() => setModalConfig({ isOpen: true, type: 'person' })}>Nuevo</Button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {filtered.map(p => (
                                <div key={p.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-start gap-4 hover:shadow-md transition-shadow group">
                                    <div className="w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-500 text-lg flex-shrink-0">
                                        {p.name.charAt(0)}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-bold text-slate-800 truncate">{p.name}</h3>
                                            <button onClick={() => setModalConfig({ isOpen: true, type: 'person', data: p })} className="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-church-navy transition-opacity"><Icon name="Edit" size={16} /></button>
                                        </div>
                                        <p className="text-xs font-bold text-church-navy mb-1">{p.role}</p>
                                        <div className="text-xs text-slate-500 space-y-0.5">
                                            {p.phone && <p>üìû {p.phone}</p>}
                                            {p.email && <p className="truncate">‚úâÔ∏è {p.email}</p>}
                                            {p.address && <p className="truncate">üìç {p.address}</p>}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // =================================================================================
            // 5. MODALES Y FORMULARIOS
            // =================================================================================

            const renderModalContent = () => {
                const { type, data } = modalConfig;
                // Hook para formulario
                const [form, setForm] = useState(data || {});

                // Sugerencias de Equipo (Regla de 2 servicios)
                const getSuggestions = () => {
                    if (type !== 'server_events') return [];
                    const lastEvents = serverEvents
                        .filter(e => e.date < (form.date || '9999'))
                        .sort((a,b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 2);
                    
                    const recentlyServed = new Set();
                    lastEvents.forEach(e => Object.values(e.assignments || {}).forEach(p => recentlyServed.add(p)));
                    // Filtrar gente que no sirvi√≥ recientemente
                    return people.filter(p => !recentlyServed.has(p.name)).slice(0, 5); 
                };

                const handleChange = (f, v) => setForm(prev => ({ ...prev, [f]: v }));

                // Footer de Guardado Gen√©rico
                const saveBtn = <Button onClick={() => handleSave(
                    type === 'person' ? 'people' : 
                    type === 'finance_income' || type === 'finance_expense' ? 'finances' : 
                    type === 'compose_message' ? 'messages' : 
                    type, 
                    form, 
                    data?.id
                )}>Guardar Datos</Button>;

                // --- FORMULARIO PERSONA (Directorio Completo) ---
                if (type === 'person') return (
                    <div className="space-y-4">
                        <Input label="Nombre Completo" value={form.name || ''} onChange={e => handleChange('name', e.target.value)} required />
                        <div className="grid grid-cols-2 gap-4">
                            <Select label="Rol Ministerial" value={form.role || 'Servidor'} onChange={e => handleChange('role', e.target.value)} 
                                options={Object.values({PASTOR:'Pastor',LW:'L√≠der de Alabanza',LS:'L√≠der de Servidores',LE:'L√≠der de EBD',LY:'L√≠der de J√≥venes',SV:'Servidor'}).map(v => ({value:v, label:v}))} 
                            />
                            <Input label="Edad" type="number" value={form.age || ''} onChange={e => handleChange('age', e.target.value)} />
                        </div>
                        <Input label="Tel√©fono / WhatsApp" value={form.phone || ''} onChange={e => handleChange('phone', e.target.value)} required />
                        <Input label="Correo Electr√≥nico" type="email" value={form.email || ''} onChange={e => handleChange('email', e.target.value)} required />
                        <Input label="Direcci√≥n / Localidad" value={form.address || ''} onChange={e => handleChange('address', e.target.value)} />
                        <div className="flex justify-end pt-4 border-t mt-4">{saveBtn}</div>
                    </div>
                );

                // --- FORMULARIO ALABANZA ---
                if (type === 'worship_events') return (
                    <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <Input label="Fecha" type="date" value={form.date || ''} onChange={e => handleChange('date', e.target.value)} />
                            <Input label="Hora" type="time" value={form.time || ''} onChange={e => handleChange('time', e.target.value)} />
                        </div>
                        <Input label="Tema Principal" value={form.theme || ''} onChange={e => handleChange('theme', e.target.value)} />
                        
                        <div className="bg-slate-100 p-4 rounded-xl border border-slate-200">
                            <label className="label-std mb-2">Lista de Canciones</label>
                            <textarea 
                                className="input-std min-h-[100px]" 
                                value={form.songsText || ''} 
                                onChange={e => handleChange('songsText', e.target.value)}
                                placeholder="Escribe la lista de canciones aqu√≠..."
                            ></textarea>
                        </div>
                        <div className="flex justify-end pt-4 border-t mt-4">{saveBtn}</div>
                    </div>
                );

                // --- FORMULARIO SERVIDORES (Con Predicador y Sugerencias) ---
                if (type === 'server_events') {
                    const suggestions = getSuggestions();
                    return (
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Fecha" type="date" value={form.date || ''} onChange={e => handleChange('date', e.target.value)} />
                                <Input label="Hora" type="time" value={form.time || ''} onChange={e => handleChange('time', e.target.value)} />
                            </div>
                            <Input label="Predicador" value={form.preacher || ''} onChange={e => handleChange('preacher', e.target.value)} placeholder="¬øQui√©n predica hoy?" />
                            
                            <div className="border-t border-slate-200 pt-4 mt-2">
                                <h4 className="font-bold text-church-navy mb-3">Asignaci√≥n de Roles</h4>
                                {['Recepci√≥n', 'Limpieza', 'Altar', 'Multimedia', 'Ni√±os'].map(role => (
                                    <div key={role} className="mb-3 flex items-center gap-3">
                                        <label className="w-24 text-xs font-bold text-slate-500 uppercase">{role}</label>
                                        <select 
                                            className="input-std flex-1 py-2"
                                            value={form.assignments?.[role] || ''} 
                                            onChange={e => handleChange('assignments', { ...(form.assignments || {}), [role]: e.target.value })}
                                        >
                                            <option value="">-- Seleccionar --</option>
                                            {people.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                        </select>
                                    </div>
                                ))}
                            </div>
                            
                            {suggestions.length > 0 && (
                                <div className="bg-green-50 p-3 rounded-lg border border-green-100 text-xs">
                                    <strong className="text-green-800 block mb-1">Sugerencia (Descansados):</strong> 
                                    <div className="flex flex-wrap gap-2">
                                        {suggestions.map(s => <span key={s.id} className="bg-white px-2 py-1 rounded shadow-sm text-green-700">{s.name}</span>)}
                                    </div>
                                </div>
                            )}
                            <div className="flex justify-end pt-4 border-t mt-4">{saveBtn}</div>
                        </div>
                    );
                }

                // --- FORMULARIO TESORER√çA (Separado) ---
                if (type === 'finance_income') return (
                    <div className="space-y-4">
                        <Input label="Fecha de Cierre" type="date" value={form.date || ''} onChange={e => handleChange('date', e.target.value)} />
                        <div className="grid grid-cols-2 gap-4">
                            <Input label="Monto Diezmos" type="number" value={form.tithes || ''} onChange={e => handleChange('tithes', e.target.value)} />
                            <Input label="Monto Ofrendas" type="number" value={form.offerings || ''} onChange={e => handleChange('offerings', e.target.value)} />
                        </div>
                        <Input label="Monto Otros Ingresos" type="number" value={form.amount || ''} onChange={e => handleChange('amount', e.target.value)} />
                        <Input label="Notas / Detalle" value={form.notes || ''} onChange={e => handleChange('notes', e.target.value)} />
                        <div className="flex justify-end pt-4 border-t mt-4">
                            <Button onClick={() => handleSave('finances', { ...form, type: 'Ingreso' })}>Guardar Cierre</Button>
                        </div>
                    </div>
                );

                if (type === 'finance_expense') return (
                    <div className="space-y-4">
                        <Input label="Fecha Gasto" type="date" value={form.date || ''} onChange={e => handleChange('date', e.target.value)} />
                        <Input label="Monto Total" type="number" value={form.amount || ''} onChange={e => handleChange('amount', e.target.value)} />
                        <Input label="Motivo / Detalle" value={form.notes || ''} onChange={e => handleChange('notes', e.target.value)} />
                        <div className="flex justify-end pt-4 border-t mt-4">
                            <Button variant="danger" onClick={() => handleSave('finances', { ...form, type: 'Gasto' })}>Registrar Salida</Button>
                        </div>
                    </div>
                );

                // --- FORMULARIO MENSAJES (Nuevo) ---
                if (type === 'compose_message') return (
                    <div className="space-y-4">
                        <Input label="Asunto" value={form.subject || ''} onChange={e => handleChange('subject', e.target.value)} />
                        <div className="mb-4">
                            <label className="label-std">Contenido</label>
                            <textarea className="input-std h-32" value={form.content || ''} onChange={e => handleChange('content', e.target.value)}></textarea>
                        </div>
                        {/* Simplificado: Siempre broadcast o tareas en V2 */}
                        <div className="bg-blue-50 p-3 rounded text-xs text-blue-700">Este mensaje se enviar√° a todos los usuarios (Difusi√≥n).</div>
                        <div className="flex justify-end pt-4 border-t mt-4">
                            <Button onClick={() => handleSave('messages', { ...form, to: 'all', fromName: userData.name, fromId: userData.id })}>Enviar</Button>
                        </div>
                    </div>
                );

                // --- FORMULARIO GEN√âRICO EBD/JOVENES ---
                if (type === 'ebd_events' || type === 'youth_events') return (
                    <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <Input label="Fecha" type="date" value={form.date || ''} onChange={e => handleChange('date', e.target.value)} />
                            <Input label="Hora" type="time" value={form.time || ''} onChange={e => handleChange('time', e.target.value)} />
                        </div>
                        <Input label="Tema / Actividad" value={form.title || ''} onChange={e => handleChange('title', e.target.value)} />
                        <Input label="Lugar" value={form.location || ''} onChange={e => handleChange('location', e.target.value)} />
                        <div className="flex justify-end pt-4 border-t mt-4">{saveBtn}</div>
                    </div>
                );

                // --- CONFIRM DELETE ---
                if (type === 'confirm_delete') return (
                    <div className="text-center py-6">
                        <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <Icon name="Trash" size={32} />
                        </div>
                        <h3 className="text-xl font-bold text-slate-800 mb-2">¬øEst√°s seguro?</h3>
                        <p className="text-slate-500 mb-8">Esta acci√≥n no se puede deshacer.</p>
                        <div className="flex justify-center gap-4">
                            <Button variant="secondary" onClick={() => setModalConfig({isOpen:false})}>Cancelar</Button>
                            <Button variant="danger" onClick={confirmDelete}>S√≠, Eliminar</Button>
                        </div>
                    </div>
                );

                return <div>Formulario no configurado</div>;
            };

            // --- VISTA GLOBAL DE EVENTO (MODAL DETALLE) ---
            const renderGlobalEvent = () => {
                if (!globalModalEvent) return null;
                const { worship, server, ebd, youth, base } = globalModalEvent;
                const date = base?.date;

                return (
                    <div className="space-y-6">
                        <div className="text-center bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <h2 className="text-2xl font-black text-church-navy uppercase tracking-widest">{formatDate(date)}</h2>
                            <p className="text-slate-500 font-bold mt-1">{getDayName(date)} ‚Ä¢ {base?.time} hs</p>
                        </div>

                        <div className="grid grid-cols-1 gap-4">
                            {/* Tarjeta Alabanza */}
                            <div className="bg-white p-4 rounded-xl border border-l-4 border-l-purple-500 shadow-sm">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-3 border-b pb-2"><Icon name="Music" className="text-purple-500"/> Alabanza</h3>
                                {worship ? (
                                    <div className="text-sm space-y-2">
                                        <p><strong className="text-slate-500">Tema:</strong> {worship.theme}</p>
                                        <div className="bg-slate-50 p-3 rounded text-slate-600 whitespace-pre-wrap text-xs font-mono">{worship.songsText || 'Sin lista de canciones'}</div>
                                    </div>
                                ) : <span className="text-slate-400 italic text-sm">Sin planificaci√≥n.</span>}
                            </div>

                            {/* Tarjeta Servidores */}
                            <div className="bg-white p-4 rounded-xl border border-l-4 border-l-green-500 shadow-sm">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-3 border-b pb-2"><Icon name="Briefcase" className="text-green-500"/> Servidores</h3>
                                {server ? (
                                    <div className="text-sm space-y-2">
                                        <p><strong className="text-slate-500">Predicador:</strong> {server.preacher || '--'}</p>
                                        <div className="grid grid-cols-2 gap-2 mt-2">
                                            {Object.entries(server.assignments || {}).map(([k,v]) => (
                                                <div key={k} className="bg-green-50 p-2 rounded"><span className="block text-[10px] font-bold uppercase text-green-700">{k}</span> <span className="font-medium">{v}</span></div>
                                            ))}
                                        </div>
                                    </div>
                                ) : <span className="text-slate-400 italic text-sm">Sin planificaci√≥n.</span>}
                            </div>
                        </div>
                        
                        <div className="text-center pt-2">
                            <Button variant="secondary" onClick={() => setGlobalModalEvent(null)} className="w-full">Cerrar</Button>
                        </div>
                    </div>
                );
            };

            // =================================================================================
            // 6. RENDERIZADO (LAYOUT)
            // =================================================================================
            return (
                <div className="flex h-screen bg-slate-50 text-slate-800 font-sans overflow-hidden">
                    {/* SIDEBAR NAVIGATION */}
                    <aside className={`fixed inset-y-0 left-0 z-40 w-72 bg-church-navy text-white transition-transform duration-300 shadow-2xl md:relative md:translate-x-0 flex flex-col ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6">
                            <div className="flex items-center gap-3 mb-10">
                                <div className="w-10 h-10 bg-church-gold rounded-xl flex items-center justify-center text-church-navy font-black text-xl shadow-lg shadow-church-gold/20">C</div>
                                <div>
                                    <h1 className="font-bold text-lg leading-none tracking-tight">Conquistadores</h1>
                                    <p className="text-xs text-church-100 opacity-60">Gesti√≥n Integral</p>
                                </div>
                            </div>

                            <nav className="space-y-1.5">
                                <button onClick={() => {setActiveTab('dashboard'); setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'dashboard' ? 'bg-white text-church-navy shadow-lg' : 'text-church-100 hover:bg-white/10'}`}>
                                    <Icon name="Home" /> Dashboard
                                </button>
                                <button onClick={() => {setActiveTab('inbox'); setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'inbox' ? 'bg-white text-church-navy shadow-lg' : 'text-church-100 hover:bg-white/10'}`}>
                                    <Icon name="Bell" /> Buz√≥n <span className="bg-red-500 text-[10px] px-1.5 py-0.5 rounded-full ml-auto font-bold">{messages.length}</span>
                                </button>

                                <div className="mt-8 mb-2 px-4 text-xs font-bold text-church-gold uppercase tracking-widest opacity-80">Ministerios</div>
                                <button onClick={() => {setActiveTab('worship'); setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'worship' ? 'bg-white text-church-navy shadow-lg' : 'text-church-100 hover:bg-white/10'}`}><Icon name="Music" /> Alabanza</button>
                                <button onClick={() => {setActiveTab('servers'); setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'servers' ? 'bg-white text-church-navy shadow-lg' : 'text-church-100 hover:bg-white/10'}`}><Icon name="Briefcase" /> Servidores</button>
                                <button onClick={() => {setActiveTab('ebd'); setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'ebd' ? 'bg-white text-church-navy shadow-lg' : 'text-church-100 hover:bg-white/10'}`}><Icon name="Book" /> EBD / J√≥venes</button>

                                {userData?.role === 'Pastor' && (
                                    <>
                                        <div className="mt-8 mb-2 px-4 text-xs font-bold text-church-gold uppercase tracking-widest opacity-80">Administraci√≥n</div>
                                        <button onClick={() => {setActiveTab('finances'); setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'finances' ? 'bg-white text-church-navy shadow-lg' : 'text-church-100 hover:bg-white/10'}`}><Icon name="DollarSign" /> Tesorer√≠a</button>
                                        <button onClick={() => {setActiveTab('directory'); setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'directory' ? 'bg-white text-church-navy shadow-lg' : 'text-church-100 hover:bg-white/10'}`}><Icon name="Users" /> Directorio</button>
                                    </>
                                )}
                            </nav>
                        </div>
                        
                        <div className="mt-auto p-4 m-4 bg-church-800 rounded-2xl flex items-center gap-3 shadow-lg">
                            <div className="w-10 h-10 rounded-full bg-white text-church-navy flex items-center justify-center font-bold text-lg">{userData?.name?.charAt(0)}</div>
                            <div className="flex-1 overflow-hidden">
                                <p className="text-sm font-bold truncate">{userData?.name}</p>
                                <p className="text-xs text-church-gold opacity-80 truncate">{userData?.role}</p>
                            </div>
                            <button onClick={() => auth.signOut()} className="text-church-100 hover:text-white"><Icon name="LogOut" size={18} /></button>
                        </div>
                    </aside>

                    {/* MAIN CONTENT AREA */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative w-full bg-slate-50">
                        {/* Mobile Header */}
                        <header className="md:hidden flex items-center justify-between p-4 bg-white border-b border-slate-100 shadow-sm z-30">
                            <div className="flex items-center gap-2 font-bold text-church-navy"><Icon name="Home" className="text-church-gold"/> Conquistadores</div>
                            <button onClick={() => setSidebarOpen(true)} className="p-2"><Icon name="Menu" /></button>
                        </header>

                        {/* Month Nav Filter */}
                        <MonthNav />

                        {/* Content Scrollable */}
                        <div className="flex-1 overflow-y-auto">
                            <div className="p-4 md:p-8 max-w-7xl mx-auto pb-24">
                                {activeTab === 'dashboard' && <DashboardView />}
                                {activeTab === 'inbox' && <InboxView />}
                                {activeTab === 'finances' && <FinancesView />}
                                {activeTab === 'directory' && <DirectoryView />}
                                {activeTab === 'worship' && <MinistryView title="Ministerio de Alabanza" events={worshipEvents} collection="worship_events" ministryKey="Alabanza" icon="Music" />}
                                {activeTab === 'servers' && <MinistryView title="Servidores y Orden" events={serverEvents} collection="server_events" ministryKey="Servidores" icon="Briefcase" />}
                                {activeTab === 'ebd' && (
                                    <div className="space-y-10">
                                        <MinistryView title="Escuela B√≠blica" events={ebdEvents} collection="ebd_events" ministryKey="EBD" icon="Book" />
                                        <MinistryView title="J√≥venes" events={youthEvents} collection="youth_events" ministryKey="J√≥venes" icon="Smile" />
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>

                    {/* OVERLAY Mobile */}
                    {sidebarOpen && <div className="fixed inset-0 bg-slate-900/50 z-30 md:hidden backdrop-blur-sm transition-opacity" onClick={() => setSidebarOpen(false)}></div>}

                    {/* MODALES */}
                    <Modal isOpen={!!globalModalEvent} onClose={() => setGlobalModalEvent(null)} title="Detalle del D√≠a" size="sm">
                        {renderGlobalEvent()}
                    </Modal>

                    <Modal isOpen={modalConfig.isOpen} onClose={() => setModalConfig({ isOpen: false, type: '', data: null })} title={modalConfig.data ? 'Editar Registro' : 'Nuevo Registro'} size={modalConfig.type === 'confirm_delete' ? 'sm' : 'md'}>
                        {modalConfig.isOpen && renderModalContent()}
                    </Modal>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
